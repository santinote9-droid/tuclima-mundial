<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naval Command | Skipper Pro Operations</title>

    <style>
        /* Animación de espera para la IA */
        .chat-typing {
            color: #94a3b8;
            font-style: italic;
            font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 24px;
        }
        .dot-typing {
            display: inline-block;
            width: 30px;
            text-align: left;
        }
        .dot-typing span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-right: 2px;
            background: #94a3b8;
            border-radius: 50%;
            opacity: 0.5;
            animation: blink 1.4s infinite both;
        }
        .dot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .dot-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.5; }
            40% { opacity: 1; }
        }
    /* CHAT TuClima IA - Paleta azul oscuro, blanco y gris claro */
    .chat-container {
        width: 100%;
        min-height: 600px;
        margin: 20px 0;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .chat-header {
        background: #0f172a;
        padding: 18px 24px;
        border-bottom: 1px solid #334155;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #e2e8f0;
    }

    .chat-header h3 {
        margin: 0;
        color: #e2e8f0;
        font-size: 1.1rem;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .status-dot {
        height: 10px; width: 10px;
        background-color: #4ade80;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 5px #4ade80;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background-color: #1e293b;
        color: #e2e8f0;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    .message {
        max-width: 80%;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 16px;
        line-height: 1.5;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .bot-msg {
        background-color: #334155;
        color: #e2e8f0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }
    .user-msg {
        background-color: #3b82f6;
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .chat-input-area {
        padding: 18px;
        background: #0f172a;
        border-top: 1px solid #334155;
        display: flex;
        gap: 10px;
    }

    .chat-input-area input[type="text"] {
        flex: 1;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #334155;
        background: #1e293b;
        color: #e2e8f0;
        font-size: 16px;
        outline: none;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        transition: border 0.2s;
    }
    .chat-input-area input[type="text"]:focus {
        border: 1.5px solid #3b82f6;
    }

    .chat-input-area button {
        padding: 12px 25px;
        background: #3b82f6;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        transition: background 0.2s, color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    .chat-input-area button:hover {
        background: #2563eb;
        color: #fff;
    }

    /* Botón de descarga de archivos en el chat */
    .chat-messages a.download-link {
        display: inline-block;
        background: #3b82f6;
        color: #fff !important;
        padding: 10px 22px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none !important;
        box-shadow: 0 2px 8px rgba(59,130,246,0.08);
        margin-top: 8px;
        margin-bottom: 2px;
        transition: background 0.2s, box-shadow 0.2s;
        border: none;
        font-family: 'Poppins', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    .chat-messages a.download-link:hover {
        background: #1e293b;
        color: #3b82f6 !important;
        box-shadow: 0 4px 16px rgba(59,130,246,0.18);
        border: 1.5px solid #3b82f6;
    }
</style>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/dark-unica.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <style>
        /* ============================================================= */
        /* 3. HOJA DE ESTILOS "DEEP OCEAN OPS" (CSS EXTENDIDO)           */
        /* ============================================================= */
        
        :root {
            /* Paleta Cromática Naval (Night Vision) */
            --bg-deep: #020617;       /* Azul Abismo (Fondo Base) */
            --bg-glass: rgba(15, 23, 42, 0.85); /* Cristal Oscuro */
            --bg-panel: #0f172a;      /* Azul Sólido */
            
            /* Bordes y Estructura */
            --border-primary: #1e3a8a; /* Azul Cobalto */
            --border-highlight: #38bdf8; /* Azul Claro */
            
            /* Acentos de Datos (Colores Semánticos) */
            --accent-cyan: #06b6d4;   /* Cian Radar (Principal) */
            --accent-gold: #facc15;   /* Amarillo Alerta */
            --accent-danger: #ef4444; /* Rojo Crítico */
            --accent-safe: #10b981;   /* Verde Operativo */
            --accent-purple: #a855f7; /* Violeta Swell */
            
            /* Tipografía */
            --text-white: #f8fafc;
            --text-muted: #94a3b8;
            
            /* Sombras y Efectos de Neón */
            --glow-cyan: 0 0 15px rgba(6, 182, 212, 0.3);
            --shadow-panel: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* Configuración Base del Documento */
        * { box-sizing: border-box; }
        
        body { 
            background-color: var(--bg-deep); 
            color: var(--text-white); 
            font-family: 'Rajdhani', sans-serif; 
            margin: 0; 
            padding-bottom: 100px;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 80%);
            background-attachment: fixed;
            min-height: 100vh;
            overflow-x: hidden; /* Evita scroll horizontal indeseado */
        }

        /* Scrollbar Personalizada (Estilo Cyberpunk/Naval) */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 6px; border: 2px solid var(--bg-deep); }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }

        /* ================================================= */
        /* HEADER SUPERIOR (BRIDGE DECK)                     */
        /* ================================================= */
        .nav-header {
            position: sticky; top: 0; 
            z-index: 500; /* Capa inferior a los modales pero sobre el contenido */
            background: rgba(2, 6, 23, 0.98);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid var(--accent-cyan);
            padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 50px rgba(6, 182, 212, 0.1);
        }

        .brand-container { display: flex; align-items: center; gap: 15px; }
        
        /* Animación del Radar en el Logo */
        .brand-logo svg { 
            filter: drop-shadow(0 0 5px var(--accent-cyan)); 
            animation: pulseRadar 4s infinite;
        }
        @keyframes pulseRadar {
            0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; }
        }

        .brand-text { 
            font-family: 'JetBrains Mono', monospace; 
            font-size: 1.8rem; 
            font-weight: 800; 
            color: #fff; 
            letter-spacing: -1px; 
            text-transform: uppercase;
        }
        .brand-text span { color: var(--accent-cyan); }
        
        .badge-version { 
            background: rgba(6, 182, 212, 0.1); 
            color: var(--accent-cyan); 
            border: 1px solid var(--accent-cyan);
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.5rem; 
            font-weight: bold; 
            letter-spacing: 2px; 
            vertical-align: middle;
            margin-left: 10px;
        }

        /* Panel de Operaciones (Derecha) */
        .ops-controls { display: flex; align-items: center; gap: 20px; }

        .coords-display {
            font-family: 'JetBrains Mono'; font-size: 0.85rem; color: var(--accent-cyan); 
            text-align: right; line-height: 1.4;
            border-right: 1px solid #334155; padding-right: 20px; margin-right: 10px;
        }
        .coords-display span { color: var(--text-muted); font-weight: normal; }

        /* Estilos de Botones Globales */
        .btn-action {
            background: linear-gradient(180deg, rgba(6,182,212,0.1) 0%, rgba(6,182,212,0.05) 100%);
            border: 1px solid var(--accent-cyan); 
            color: var(--accent-cyan);
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer; 
            transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px; 
            font-family: 'JetBrains Mono'; font-weight: bold; font-size: 0.9rem;
        }
        .btn-action:hover { 
            background: var(--accent-cyan); color: #000; 
            box-shadow: 0 0 20px var(--accent-cyan); 
        }

        .btn-calc { 
            border-color: var(--accent-gold); 
            color: var(--accent-gold); 
            background: rgba(250, 204, 21, 0.05); 
        }
        .btn-calc:hover { 
            background: var(--accent-gold); color: #000; 
            box-shadow: 0 0 20px var(--accent-gold); 
        }

        .btn-logout {
            color: var(--accent-danger); text-decoration: none; font-weight: bold; 
            border: 1px solid var(--accent-danger); padding: 10px 15px; border-radius: 6px; 
            transition: 0.3s; font-family: 'JetBrains Mono'; font-size: 0.9rem;
        }
        .btn-logout:hover { background: var(--accent-danger); color: #fff; box-shadow: 0 0 15px var(--accent-danger); }

        /* ============================================================= */
        /* 4. GRILLA MAESTRA (3x3 FORZADA)                               */
        /* ============================================================= */
        .dashboard-grid {
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 COLUMNAS SIEMPRE EN DESKTOP */
            gap: 30px;
            padding: 40px; 
            max-width: 1800px; margin: 0 auto;
        }
        
        /* Solo romper la simetría en móviles puros */
        @media (max-width: 1024px) { 
            .dashboard-grid { grid-template-columns: repeat(2, 1fr); padding: 20px; } 
        }
        @media (max-width: 768px) { 
            .dashboard-grid { grid-template-columns: 1fr; } 
        }

        /* ============================================================= */
        /* 5. TARJETAS DE INSTRUMENTOS (CARDS)                           */
        /* ============================================================= */
        .instrument-card {
            background: var(--bg-glass); 
            border: 1px solid var(--border-primary); 
            border-radius: 16px;
            padding: 25px; 
            position: relative; 
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex; flex-direction: column; justify-content: space-between; 
            min-height: 240px; /* Altura garantizada para consistencia */
            backdrop-filter: blur(10px);
            overflow: hidden;
            z-index: 1;
        }

        /* Efectos Hover */
        .instrument-card:hover { 
            border-color: var(--accent-cyan); 
            transform: translateY(-5px); 
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4), inset 0 0 0 1px rgba(6, 182, 212, 0.2);
        }

        /* Header de la Tarjeta */
        .card-header { 
            display: flex; justify-content: space-between; align-items: flex-start; 
            margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 12px; 
        }
        .card-title { 
            font-family: 'JetBrains Mono'; color: var(--accent-cyan); font-weight: 700; font-size: 0.85rem; 
            text-transform: uppercase; letter-spacing: 1.5px; 
        }
        .card-icon { width: 24px; height: 24px; opacity: 0.8; color: var(--accent-cyan); }

        /* Cuerpo de la Tarjeta */
        .card-body { 
            text-align: center; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; 
        }
        
        .value-primary { 
            font-family: 'JetBrains Mono'; font-size: 3.5rem; font-weight: 800; color: #fff; 
            line-height: 1; text-shadow: 0 0 30px rgba(6, 182, 212, 0.15); margin-bottom: 5px;
        }
        .value-unit { font-size: 0.4em; color: var(--text-muted); font-weight: 400; margin-left: 5px; vertical-align: super; }
        
        .value-secondary { 
            font-size: 1.1rem; color: var(--text-muted); margin-top: 10px; font-weight: 600; 
            text-transform: uppercase; letter-spacing: 1px;
        }

        /* Footer de Datos */
        .card-footer { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.05); font-size: 0.95rem; margin-top: auto; 
        }
        .footer-label { color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
        .footer-value { font-family: 'JetBrains Mono'; color: #fff; font-weight: bold; }

        /* ============================================================= */
        /* 6. BARRA DE VISIBILIDAD (DASHBOARD STRIP)                     */
        /* ============================================================= */
        .visibility-strip {
            max-width: 1720px; margin: 0 auto 40px auto; padding: 25px 40px;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.9) 0%, rgba(30, 58, 138, 0.3) 100%);
            border: 1px solid var(--border-primary); 
            border-left: 6px solid var(--accent-cyan); 
            border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .visibility-strip:hover { 
            border-color: var(--accent-cyan); 
            box-shadow: 0 0 30px rgba(6, 182, 212, 0.1); 
            transform: scale(1.002); 
        }

        /* ============================================================= */
        /* 7. SECCIÓN DE ANÁLISIS PROFUNDO (MAPA + GRÁFICO)              */
        /* ============================================================= */
        .analysis-deck {
            max-width: 1720px; margin: 0 auto 60px auto;
            display: grid; 
            grid-template-columns: 1fr 1fr; /* Dividido en dos columnas */
            gap: 40px; 
        }
        /* En pantallas chicas, apilamos el mapa y el gráfico */
        @media (max-width: 1200px) { .analysis-deck { grid-template-columns: 1fr; } }

        .analysis-panel {
            background: var(--bg-glass); 
            border: 1px solid var(--border-primary); border-radius: 16px;
            padding: 5px; position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            min-height: 480px; /* Altura generosa */
        }

        .panel-header {
            padding: 15px 25px; background: rgba(2, 6, 23, 0.9);
            border-bottom: 1px solid var(--border-primary);
            font-family: 'Rajdhani'; font-weight: 700; font-size: 1.4rem; color: var(--text-white);
            display: flex; align-items: center; gap: 15px; text-transform: uppercase; letter-spacing: 2px;
        }

        /* ============================================================= */
        /* 8. VENTANAS MODALES (SISTEMA DE INFORMACIÓN CRÍTICA)          */
        /* ============================================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.96); /* Fondo casi opaco para enfoque */
            backdrop-filter: blur(10px); 
            z-index: 10000; /* Z-Index NUCLEAR para estar encima de todo */
            display: none; /* Oculto por defecto */
            justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        
        /* Clase para activar animación al abrir */
        .modal-overlay.active { opacity: 1; }

        .modal-box {
            background: #0f172a; 
            border: 1px solid var(--accent-cyan); 
            width: 90%; max-width: 950px;
            padding: 50px; 
            border-radius: 20px; 
            position: relative; 
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 0 100px rgba(6, 182, 212, 0.3);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-box { transform: scale(1); }
        
        .btn-close-modal {
            position: absolute; top: 25px; right: 30px; font-size: 3rem; color: var(--text-muted);
            background: none; border: none; cursor: pointer; transition: 0.3s; line-height: 0.5;
        }
        .btn-close-modal:hover { color: var(--accent-danger); transform: rotate(90deg); }

        .modal-title { 
            font-family: 'JetBrains Mono'; color: var(--accent-cyan); font-size: 2rem; margin-bottom: 25px; 
            border-bottom: 2px solid var(--border-primary); padding-bottom: 15px; 
            display: flex; align-items: center; gap: 20px;
        }
        .modal-text { 
            color: #cbd5e1; line-height: 1.8; margin-bottom: 30px; font-size: 1.1rem; text-align: justify;
        }
        
        /* Tablas Técnicas dentro de Modales */
        .tech-table { 
            width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 30px; 
            background: #020617; border-radius: 12px; overflow: hidden; border: 1px solid var(--border-primary); 
        }
        .tech-table th { 
            background: #1e3a8a; color: #fff; padding: 18px; text-align: left; 
            font-family: 'JetBrains Mono'; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; 
        }
        .tech-table td { 
            padding: 18px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #cbd5e1; font-size: 1rem; 
        }
        .tech-table tr:hover td { background: rgba(6, 182, 212, 0.08); color: #fff; }

        .info-highlight {
            background: rgba(6, 182, 212, 0.05); border-left: 6px solid var(--accent-cyan);
            padding: 25px; margin-top: 30px; color: #fff; font-size: 1.1rem; 
            font-family: 'JetBrains Mono'; border-radius: 0 8px 8px 0;
        }

        /* Etiquetas de Estado (Tags) */
        .status-tag { padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 0.85rem; text-transform: uppercase; }
        .st-risk { color: var(--accent-danger); background: rgba(239, 68, 68, 0.1); border: 1px solid var(--accent-danger); }
        .st-warn { color: var(--accent-gold); background: rgba(250, 204, 21, 0.1); border: 1px solid var(--accent-gold); }
        .st-safe { color: var(--accent-safe); background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-safe); }

        /* Estilos de la Calculadora */
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .calc-input { background: #020617; border: 1px solid #334155; color: #fff; padding: 15px; width: 100%; border-radius: 8px; font-family: 'JetBrains Mono'; font-size: 1.2rem; }
        .calc-select { background: #1e3a8a; border: 1px solid #334155; color: #fff; padding: 15px; width: 100%; border-radius: 8px; font-family: 'Rajdhani'; font-weight: bold; font-size: 1.1rem; }
        .calc-btn-exec { width: 100%; padding: 15px; background: var(--accent-gold); color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1rem; transition: 0.2s; font-family: 'JetBrains Mono'; margin-top: 15px; }
        .calc-btn-exec:hover { transform: scale(1.02); box-shadow: 0 0 20px var(--accent-gold); }
        .calc-result { margin-top: 20px; text-align: center; font-size: 2.5rem; color: var(--accent-cyan); font-family: 'JetBrains Mono'; font-weight: 800; border: 1px solid var(--border-primary); padding: 20px; border-radius: 12px; background: rgba(6,182,212,0.05); }

    </style>

<script type="text/javascript" src="https://cdn.weglot.com/weglot.min.js"></script>
    <script>
        Weglot.initialize({
            api_key: 'wg_169c193b22e7a117be85a2f56113ab415', // <--- TU LLAVE REAL
            hide_switcher: true,         // Oculta el botón estándar (usaremos el nuestro)
            auto_switch: true            // Detecta idioma automático
        });
    </script>
</head>
<body>

    <div id="google_translate_element" style="display:none;"></div>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <header class="nav-header">
        <div class="brand-container">
            <div class="brand-logo">
                <svg width="42" height="42" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg>
            </div>
            <div class="brand-text">NAVAL <span>COMMAND</span> <span class="badge-version">PRO</span></div>
        </div>

        <div class="ops-controls">
            <div class="coords-display">
                <span>LAT:</span> {{ lat|floatformat:4 }} <br> <span>LON:</span> {{ lon|floatformat:4 }}
            </div>
            
            <button class="btn-action btn-calc" onclick="openModal('modConverter')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></svg>
                CALCULADORA
            </button>

            <button class="btn-action" onclick="copiarBitacora()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>
                BITÁCORA
            </button>
            
            <a href="/" class="btn-logout">✕ SALIR</a>
        </div>
    </header>

    <div class="dashboard-grid">

        <div class="instrument-card" onclick="openModal('modStatus')" style="border-top: 6px solid {{ status.color }}">
            <div class="card-header">
                <span class="card-title">Condición de Puerto</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="{{ status.color }}" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary" style="color:{{ status.color }}; font-size:2.8rem;">{{ status.msg }}</div>
                <div class="value-secondary">OPERATIVIDAD DEP.</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Criterio</span><span class="footer-value">OLA + VIENTO</span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modMar')">
            <div class="card-header">
                <span class="card-title">Estado del Mar</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h20"/><path d="M2 17h20"/><path d="M2 7h20"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary" style="color:var(--accent-cyan)">{{ mar.altura }}<span class="value-unit">m</span></div>
                <div class="value-secondary">{{ mar.estado }}</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Escala Douglas</span>
                <span class="footer-value">GRADO {{ mar.douglas }}</span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modViento')">
            <div class="card-header">
                <span class="card-title">Viento (Nudos)</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary" style="color:var(--accent-gold)">{{ viento.kt }}<span class="value-unit">kt</span></div>
                <div class="value-secondary">{{ viento.desc }} (F{{ viento.beaufort }})</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Ráfagas (Gusts)</span>
                <span class="footer-value">{{ viento.rafaga }} kt</span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modOla')">
            <div class="card-header">
                <span class="card-title">Periodo de Ola</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary">{{ mar.periodo }}<span class="value-unit">s</span></div>
                <div class="value-secondary">Intervalo Pico</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Energía</span>
                <span class="footer-value">
                    {% if mar.periodo > 10 %}<span style="color:var(--accent-danger)">ALTA (SWELL)</span>{% else %}MEDIA (LOCAL){% endif %}
                </span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modSwell')">
            <div class="card-header">
                <span class="card-title">Mar de Fondo</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary" style="color:var(--accent-purple)">{{ swell.altura }}<span class="value-unit">m</span></div>
                <div class="value-secondary">Swell Secundario</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Procedencia</span>
                <span class="footer-value">{{ swell.dir|default:"-" }}°</span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modAstro')">
            <div class="card-header">
                <span class="card-title">Astronomía</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
            </div>
            <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center; gap:12px;">
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding-bottom:5px;">
                    <span style="color:var(--text-muted); font-size:0.9rem;">AMANECER</span>
                    <span style="font-family:'JetBrains Mono'; color:var(--accent-gold); font-weight:bold;">{{ astro.amanecer }}</span>
                </div>
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid #334155; padding-bottom:5px;">
                    <span style="color:var(--text-muted); font-size:0.9rem;">ATARDECER</span>
                    <span style="font-family:'JetBrains Mono'; color:#f97316; font-weight:bold;">{{ astro.atardecer }}</span>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span style="color:var(--text-muted); font-size:0.9rem;">LUZ TOTAL</span>
                    <span style="font-family:'JetBrains Mono'; color:#fff; font-weight:bold;">{{ astro.luz }} hs</span>
                </div>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modAmbiente')">
            <div class="card-header">
                <span class="card-title">Ambiente (Aire)</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary">{{ ambiente.temp }}<span class="value-unit">°C</span></div>
                <div class="value-secondary">Temp. Seca</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Sensación</span><span class="footer-value">{{ ambiente.sensacion }}°C</span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modAgua')">
            <div class="card-header">
                <span class="card-title">Temp. Agua (SST)</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.8-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z"/><path d="M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary" style="color:var(--accent-cyan)">{{ nav.temp_agua }}<span class="value-unit">°C</span></div>
                <div class="value-secondary">Superficial</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Hipotermia</span>
                <span class="footer-value">{% if nav.temp_agua < 15 %}<span style="color:var(--accent-danger)">RIESGO</span>{% else %}BAJO{% endif %}</span>
            </div>
        </div>

        <div class="instrument-card" onclick="openModal('modPresion')">
            <div class="card-header">
                <span class="card-title">Barómetro (QNH)</span>
                <svg class="card-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16.2 7.8l-2.1 6.3-6.3 2.1 2.1-6.3z"/></svg>
            </div>
            <div class="card-body">
                <div class="value-primary">{{ nav.presion }}<span class="value-unit">hPa</span></div>
                <div class="value-secondary">Nivel del Mar</div>
            </div>
            <div class="card-footer">
                <span class="footer-label">Tendencia</span><span class="footer-value">ESTABLE</span>
            </div>
        </div>

    </div> <div class="visibility-strip" onclick="openModal('modVis')">
        <div style="font-family:'JetBrains Mono'; font-weight:bold; color:var(--text-muted); display:flex; align-items:center; gap:15px; font-size:1.2rem;">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg>
            VISIBILIDAD NÁUTICA
        </div>
        <div style="font-family:'JetBrains Mono'; font-size:2rem; font-weight:bold; color:var(--accent-cyan)">
             {{ nav.vis_nm }} Millas Náuticas ({{ nav.cond_vis }})
        </div>
        <div style="font-size:0.9rem; color:var(--text-muted); font-family:'JetBrains Mono'; text-transform:uppercase; letter-spacing:1px;">
            VER TABLA DE ALCANCE >
        </div>
    </div>


   <div style="max-width: 1720px; margin: 0 auto 40px auto; display: block;">
        <div class="analysis-panel" style="background: rgba(15, 23, 42, 0.85); border: 1px solid #1e3a8a; border-radius: 16px; overflow: hidden;">
            
            <div class="panel-header" style="padding: 15px 25px; background: rgba(2, 6, 23, 0.9); border-bottom: 1px solid #1e3a8a; font-family: 'Rajdhani'; font-weight: 700; font-size: 1.4rem; color: #fff; display: flex; align-items: center; gap: 15px;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#facc15" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="12" y1="16" x2="12" y2="8"/></svg>
                TENDENCIA 24 HORAS (OLAS VS VIENTO)
            </div>
            
            <div id="navalChart" style="width:100%; height:450px;"></div>
        
        </div>
    </div>

               
                    

    <div id="modConverter" class="modal-overlay" onclick="closeModal('modConverter')">
        <div class="modal-box" style="max-width:500px;" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modConverter')">×</button>
            <div class="modal-title">Conversor Náutico</div>
            <div class="calc-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <label style="color:#94a3b8; font-size:0.8rem; margin-bottom:5px; display:block;">CANTIDAD</label>
                    <input type="number" id="calcInput" class="calc-input" placeholder="0" style="background: #020617; border: 1px solid #334155; color: #fff; padding: 15px; width: 100%; border-radius: 8px;">
                </div>
                <div>
                    <label style="color:#94a3b8; font-size:0.8rem; margin-bottom:5px; display:block;">UNIDAD</label>
                    <select id="calcType" class="calc-select" style="background: #1e3a8a; border: 1px solid #334155; color: #fff; padding: 15px; width: 100%; border-radius: 8px;">
                        <option value="kts_kmh">Nudos → Km/h</option>
                        <option value="kmh_kts">Km/h → Nudos</option>
                        <option value="m_ft">Metros → Pies</option>
                        <option value="ft_m">Pies → Metros</option>
                        <option value="c_f">°C → °F</option>
                    </select>
                </div>
            </div>
            <button onclick="calcular()" style="width: 100%; padding: 15px; background: #facc15; color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer;">CALCULAR</button>
            <div style="margin-top: 20px; text-align: center; font-size: 2.5rem; color: #06b6d4; font-family: 'JetBrains Mono'; font-weight: 800; border: 1px solid #1e3a8a; padding: 20px; border-radius: 12px; background: rgba(6,182,212,0.05);">
                <span id="calcRes">0</span> <span id="calcUnit" style="font-size:0.5em; vertical-align:middle;">-</span>
            </div>
        </div>
    </div>

    <div id="modSwell" class="modal-overlay" onclick="closeModal('modSwell')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modSwell')">×</button>
            <div class="modal-title">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/></svg>
                Mar de Fondo (Swell)
            </div>
            <div class="modal-text">
                El <strong>Swell</strong> son olas generadas por tormentas a gran distancia que viajan miles de kilómetros. Son olas ordenadas, de largo periodo y gran energía.
                <br><br>
                <strong>⚠️ Peligro de "Shoaling":</strong> Cuando un swell de largo periodo llega a la costa, su altura puede duplicarse repentinamente al tocar fondo.
            </div>
            
            <table class="tech-table">
                <thead><tr><th>Periodo (s)</th><th>Tipo de Ola</th><th>Efecto en Navegación</th></tr></thead>
                <tbody>
                    <tr><td>< 6s</td><td>Mar de Viento (Chop)</td><td>Golpeteo constante ("Pantocazos"). Incómodo.</td></tr>
                    <tr><td>8 - 12s</td><td>Swell Medio</td><td>Movimiento de ascenso/descenso suave.</td></tr>
                    <tr><td>> 14s</td><td><span class="st-risk">GROUNDSWELL</span></td><td>Gran energía. <strong>Rolido profundo</strong> si se toma de través. Rompientes violentas.</td></tr>
                </tbody>
            </table>

            <div class="info-highlight">
                <strong>Consejo de Maniobra:</strong> Nunca tome un Swell de largo periodo (>12s) por el través (de costado). Cambie el rumbo 45° para "amurar" la ola.
            </div>
        </div>
    </div>

    <div id="modAstro" class="modal-overlay" onclick="closeModal('modAstro')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modAstro')">×</button>
            <div class="modal-title">Navegación Astronómica</div>
            <div class="modal-text">
                Fases de luz solar críticas para la navegación visual y el uso de sextante.
            </div>
            
            <table class="tech-table">
                <thead><tr><th>Fase</th><th>Elevación Sol</th><th>Visibilidad Horizonte</th></tr></thead>
                <tbody>
                    <tr><td>Día</td><td>> 0°</td><td>Total. Navegación visual costera segura.</td></tr>
                    <tr><td>Crepúsculo Civil</td><td>0° a -6°</td><td>Buena. Se distinguen boyas y costa sin luz artificial.</td></tr>
                    <tr><td>Crepúsculo Náutico</td><td>-6° a -12°</td><td><strong>Límite Sextante.</strong> Se ve el horizonte pero no detalles.</td></tr>
                    <tr><td>Noche</td><td>< -18°</td><td>Nula. Navegación por instrumentos y faros.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modPresion" class="modal-overlay" onclick="closeModal('modPresion')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modPresion')">×</button>
            <div class="modal-title">Barometría y Pronóstico</div>
            <div class="modal-text">
                El valor absoluto de la presión (QNH) es menos importante que su <strong>tendencia</strong>. Un cambio rápido es la alerta más fiable de mal tiempo en alta mar.
            </div>
            
            <table class="tech-table">
                <thead><tr><th>Tendencia (3hs)</th><th>Pronóstico</th></tr></thead>
                <tbody>
                    <tr><td>Estable / Sube Lento</td><td>Buen tiempo continuo. Vientos suaves.</td></tr>
                    <tr><td>Baja Lento (< 1 hPa)</td><td>Cambio gradual. Posible lluvia en 24hs.</td></tr>
                    <tr><td>Baja Rápido (> 3 hPa)</td><td><span class="st-warn">ALERTA</span> Frente frío o tormenta inminente (6-12hs).</td></tr>
                    <tr><td>Baja Explosiva (> 6 hPa)</td><td><span class="st-risk">CICLOGÉNESIS</span> Temporal severo inmediato. Buscar refugio.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modStatus" class="modal-overlay" onclick="closeModal('modStatus')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modStatus')">×</button>
            <div class="modal-title">Condición de Puerto</div>
            <div class="modal-text">Estimación operativa para embarcaciones deportivas.</div>
            <table class="tech-table">
                <thead><tr><th>Estado</th><th>Criterio (Viento / Ola)</th></tr></thead>
                <tbody>
                    <tr><td><span class="st-safe">ABIERTO</span></td><td>Viento < 15kt Y Ola < 1.5m</td></tr>
                    <tr><td><span class="st-warn">PRECAUCIÓN</span></td><td>Viento 15-25kt O Ola 1.5-2.5m</td></tr>
                    <tr><td><span class="st-risk">CERRADO</span></td><td>Viento > 25kt O Ola > 2.5m</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modMar" class="modal-overlay" onclick="closeModal('modMar')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modMar')">×</button>
            <div class="modal-title">Escala Douglas (Estado del Mar)</div>
            <table class="tech-table">
                <thead><tr><th>Grado</th><th>Altura (m)</th><th>Descripción</th></tr></thead>
                <tbody>
                    <tr><td>0-2</td><td>0 - 0.5</td><td>Calma / Marejadilla</td></tr>
                    <tr><td>3</td><td>0.5 - 1.25</td><td>Marejada</td></tr>
                    <tr><td>4</td><td>1.25 - 2.5</td><td>Fuerte Marejada</td></tr>
                    <tr><td>5</td><td>2.5 - 4.0</td><td><span class="st-warn">Gruesa</span></td></tr>
                    <tr><td>6+</td><td>> 4.0</td><td><span class="st-risk">Muy Gruesa / Arbolada</span></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modViento" class="modal-overlay" onclick="closeModal('modViento')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modViento')">×</button>
            <div class="modal-title">Escala Beaufort</div>
            <table class="tech-table">
                <thead><tr><th>F</th><th>Nudos</th><th>Efecto</th></tr></thead>
                <tbody>
                    <tr><td>4</td><td>11-16</td><td>Borreguitos frecuentes.</td></tr>
                    <tr><td>5</td><td>17-21</td><td>Olas moderadas, mucha espuma.</td></tr>
                    <tr><td>6</td><td>22-27</td><td>Olas grandes, crestas blancas.</td></tr>
                    <tr><td>8+</td><td>> 34</td><td><span class="st-risk">TEMPORAL</span></td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modVis" class="modal-overlay" onclick="closeModal('modVis')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modVis')">×</button>
            <div class="modal-title">Visibilidad Náutica</div>
            <table class="tech-table">
                <thead><tr><th>Distancia</th><th>Condición</th><th>Acción</th></tr></thead>
                <tbody>
                    <tr><td>< 0.5 NM</td><td><span class="st-risk">NIEBLA</span></td><td>Radar. Señales fónicas.</td></tr>
                    <tr><td>0.5 - 2 NM</td><td><span class="st-warn">REDUCIDA</span></td><td>Vel. Seguridad. Vigía.</td></tr>
                    <tr><td>> 5 NM</td><td><span class="st-safe">BUENA</span></td><td>Navegación normal.</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modOla" class="modal-overlay" onclick="closeModal('modOla')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modOla')">×</button>
            
            <div class="modal-title">
                <svg width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                Dinámica de Ola (Periodo)
            </div>

            <div class="modal-text">
                El <strong>Periodo (T)</strong> es el tiempo en segundos entre el paso de dos crestas consecutivas. Es el indicador directo de la <strong>ENERGÍA</strong> y la potencia de la ola.
                <br><br>
                <em>"A mayor periodo, mayor longitud de onda y velocidad."</em> Una ola de largo periodo (Swell) viaja más rápido y, al tocar fondo cerca de la costa, su altura crece exponencialmente (efecto <strong>Shoaling</strong>).
            </div>

            <table class="tech-table">
                <thead>
                    <tr>
                        <th>Periodo (s)</th>
                        <th>Clasificación</th>
                        <th>Comportamiento y Riesgo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>< 6 s</strong></td>
                        <td>Mar de Viento (Chop)</td>
                        <td>Olas cortas, "cuadradas" y caóticas. Generan pantocazos (golpes secos) e incomodidad constante.</td>
                    </tr>
                    <tr>
                        <td><strong>6 - 9 s</strong></td>
                        <td>Transición</td>
                        <td>Mezcla de mar local y fondo. Navegación moderada.</td>
                    </tr>
                    <tr>
                        <td><strong>10 - 14 s</strong></td>
                        <td>Swell (Mar de Fondo)</td>
                        <td>Olas ordenadas y potentes. Movimiento de ascenso/descenso suave en alta mar, pero <strong>rompientes fuertes en costa</strong>.</td>
                    </tr>
                    <tr>
                        <td><strong>> 15 s</strong></td>
                        <td><span class="st-risk">GROUNDSWELL</span></td>
                        <td><strong>ENERGÍA EXTREMA.</strong> Peligro de vuelco si se toma de través. Rompientes masivas en puertos y playas.</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-highlight">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>PERIODO ACTUAL (PICO):</strong> <span style="font-size:1.5em; color:var(--accent-cyan);">{{ mar.periodo }} s</span>
                    </div>
                    <div>
                        <strong>TIPO:</strong> 
                        {% if mar.periodo < 6 %}
                            <span class="status-tag st-warn">MAR DE VIENTO</span>
                        {% elif mar.periodo < 10 %}
                            <span class="status-tag st-safe">TRANSICIÓN</span>
                        {% else %}
                            <span class="status-tag st-risk">SWELL POTENTE</span>
                        {% endif %}
                    </div>
                </div>
                <hr style="border:0; border-top:1px solid #334155; margin:15px 0;">
                <small style="color:#94a3b8;">*Consejo: Con periodos largos (>10s), aumente la distancia de seguridad con la costa y evite navegar paralelo a las olas.</small>
            </div>
        </div>
    </div>

    <div id="modAmbiente" class="modal-overlay" onclick="closeModal('modAmbiente')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modAmbiente')">×</button>
            <div class="modal-title">Datos Ambientales</div>
            <div class="modal-text">
                En el mar, la temperatura real del aire no cuenta toda la historia. La humedad y el viento alteran drásticamente la percepción térmica.
            </div>
            <table class="tech-table">
                <thead><tr><th>Variable</th><th>Efecto en Navegación</th></tr></thead>
                <tbody>
                    <tr><td><strong>Temp. Aire</strong></td><td>Dato base medido en termómetro seco.</td></tr>
                    <tr><td><strong>Humedad</strong></td><td>Si es > 90%, riesgo de niebla. Afecta equipos electrónicos.</td></tr>
                    <tr><td><strong>Sensación</strong></td><td>
                        <span style="color:#ef4444; font-weight:bold;">Golpe de Calor:</span> Si > 40°C.<br>
                        <span style="color:#ef4444; font-weight:bold;">Congelación:</span> Si < 0°C (Wind Chill).
                    </td></tr>
                </tbody>
            </table>
            <div class="info-highlight" style="background: rgba(6, 182, 212, 0.05); border-left: 6px solid #06b6d4; padding: 25px; margin-top: 30px;">
                DATOS ACTUALES: {{ ambiente.temp }}°C (Sensación: {{ ambiente.sensacion }}°C)
            </div>
        </div>
    </div>

    <div id="modAgua" class="modal-overlay" onclick="closeModal('modAgua')">
        <div class="modal-box" onclick="event.stopPropagation()">
            <button class="btn-close-modal" onclick="closeModal('modAgua')">×</button>
            <div class="modal-title">Temperatura del Agua y Supervivencia</div>
            <div class="modal-text">
                Estimación de tiempos críticos de supervivencia para un hombre al agua (MOB) sin traje de inmersión. El agua roba calor 25 veces más rápido que el aire.
            </div>
            <table class="tech-table">
                <thead><tr><th>Temp. Agua</th><th>Tiempo Inconsciencia</th><th>Tiempo Muerte (Hipotermia)</th></tr></thead>
                <tbody>
                    <tr><td>< 5°C</td><td>< 15 min</td><td style="color:#ef4444; font-weight:bold;">< 45 min</td></tr>
                    <tr><td>5 - 10°C</td><td>30 - 60 min</td><td style="color:#facc15; font-weight:bold;">1 - 3 horas</td></tr>
                    <tr><td>10 - 15°C</td><td>1 - 2 horas</td><td>1 - 6 horas</td></tr>
                    <tr><td>> 20°C</td><td>> 12 horas</td><td style="color:#10b981; font-weight:bold;">Indefinido</td></tr>
                </tbody>
            </table>
            <div class="info-highlight" style="background: rgba(6, 182, 212, 0.05); border-left: 6px solid #06b6d4; padding: 25px; margin-top: 30px;">
                TEMP. SUPERFICIAL ACTUAL: <strong>{{ nav.temp_agua }}°C</strong>
            </div>
        </div>
    </div>


        <script>
        // 1. TRADUCTOR AUTOMÁTICO
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({ pageLanguage: 'es', includedLanguages: 'en,fr,pt,de', autoDisplay: false }, 'google_translate_element');
        }
        window.addEventListener('load', function() {
            var l = (navigator.language || navigator.userLanguage).split('-')[0];
            if (l !== 'es') {
                setTimeout(function() {
                    var s = document.querySelector('select.goog-te-combo');
                    if (s) { s.value = l; s.dispatchEvent(new Event('change')); }
                }, 1000);
            }
        });

        // 2. MODALES (BLINDADO)
        function openModal(id) {
            const m = document.getElementById(id);
            if (m) { m.style.display = 'flex'; setTimeout(() => m.classList.add('active'), 10); }
        }
        function closeModal(id) {
            const m = document.getElementById(id);
            if (m) { m.classList.remove('active'); setTimeout(() => m.style.display = 'none', 300); }
        }
        window.onclick = function(e) { if (e.target.classList && e.target.classList.contains('modal-overlay')) { closeModal(e.target.id); } }

        // 3. CALCULADORA DE UNIDADES
        function calcular() {
            let val = parseFloat(document.getElementById('calcInput').value);
            let type = document.getElementById('calcType').value;
            let res = 0; let unit = "";

            if (isNaN(val)) { document.getElementById('calcRes').innerText = "-"; return; }

            switch(type) {
                case 'kts_kmh': res = val * 1.852; unit = "km/h"; break;
                case 'kmh_kts': res = val / 1.852; unit = "kts"; break;
                case 'm_ft': res = val * 3.28084; unit = "ft"; break;
                case 'ft_m': res = val / 3.28084; unit = "m"; break;
                case 'c_f': res = (val * 9/5) + 32; unit = "°F"; break;
            }
            document.getElementById('calcRes').innerText = res.toFixed(1);
            document.getElementById('calcUnit').innerText = unit;
        }

        // 4. BITÁCORA
        function copiarBitacora() {
            const txt = `⚓ BITÁCORA NAVAL\nPos: {{ lat|floatformat:4 }}, {{ lon|floatformat:4 }}\nFecha: ${new Date().toLocaleString()}\n\n🌊 MAR: {{ mar.altura }}m ({{ mar.estado }})\n💨 VIENTO: {{ viento.kt }}kt (F{{ viento.beaufort }})\n👁️ VIS: {{ nav.vis_nm }} NM\n🌡️ AGUA: {{ nav.temp_agua }}°C\n\nGenerado por TuClima Pro.`;
            navigator.clipboard.writeText(txt).then(() => alert("✅ Bitácora copiada"));
        }
    </script>

    <div id="traducciones-naval" style="display: none;">
        <span id="txt-olas-serie">Altura de Ola</span>
        <span id="txt-viento-serie">Viento</span>
        <span id="txt-axis-olas">Olas (m)</span>
        <span id="txt-axis-viento">Viento (nudos)</span>
    </div>

    <script>
        let chartNaval; // Variable global

        // 2. FUNCIÓN DE DIBUJO (Lee traducciones)
        function renderNavalChart() {
            // Datos seguros desde Django
            const fechas = {{ grafico_naval.fechas|default:"[]"|safe }};
            const olas = {{ grafico_naval.olas|default:"[]"|safe }};
            const vientos = {{ grafico_naval.viento|default:"[]"|safe }};

            // Textos por defecto (ESPAÑOL PURO)
            let tOlas = "Altura de Ola";
            let tViento = "Viento";
            let tAxisOlas = "Olas (m)";
            let tAxisViento = "Viento (nudos)";

            // Intentar leer traducciones (si existen)
            try {
                if (document.getElementById('txt-olas-serie')) tOlas = document.getElementById('txt-olas-serie').innerText;
                if (document.getElementById('txt-viento-serie')) tViento = document.getElementById('txt-viento-serie').innerText;
                if (document.getElementById('txt-axis-olas')) tAxisOlas = document.getElementById('txt-axis-olas').innerText;
                if (document.getElementById('txt-axis-viento')) tAxisViento = document.getElementById('txt-axis-viento').innerText;
            } catch(e) { console.log("Usando textos base Naval"); }

            // Configuración Highcharts
            chartNaval = Highcharts.chart('navalChart', {
                chart: { backgroundColor: 'transparent', style: { fontFamily: 'Rajdhani' }, type: 'column' },
                exporting: {
                    enabled: true,
                    chartOptions: { chart: { backgroundColor: '#020617' } },
                    buttons: { contextButton: { symbolStroke: '#06b6d4', theme: { fill: '#0f172a' } } }
                },
                title: { text: '' },
                xAxis: {
                    categories: fechas,
                    lineColor: '#1e3a8a',
                    labels: { style: { color: '#94a3b8', fontFamily: 'JetBrains Mono' } }
                },
                yAxis: [{
                    title: { text: tAxisOlas, style: { color: '#06b6d4' } },
                    gridLineColor: '#1e3a8a',
                    labels: { style: { color: '#06b6d4' } }
                }, {
                    title: { text: tAxisViento, style: { color: '#facc15' } },
                    opposite: true,
                    labels: { style: { color: '#facc15' } }
                }],
                legend: { itemStyle: { color: '#e2e8f0' } },
                tooltip: { shared: true, backgroundColor: 'rgba(15,23,42,0.9)', style: { color: '#fff' }, borderColor: '#06b6d4' },
                series: [{
                    name: tOlas,
                    data: olas,
                    color: '#06b6d4',
                    borderColor: '#0ea5e9',
                    borderWidth: 1,
                    yAxis: 0
                }, {
                    name: tViento,
                    type: 'spline',
                    data: vientos,
                    color: '#facc15',
                    dashStyle: 'ShortDot',
                    yAxis: 1,
                    marker: { enabled: false }
                }],
                credits: { enabled: false }
            });
        }

        // 3. INICIALIZACIÓN Y SINCRONIZACIÓN
        document.addEventListener("DOMContentLoaded", function() {
            renderNavalChart(); // Dibujar primera vez

            // Si Weglot está presente, redibujar al cambiar idioma
            if (typeof Weglot !== 'undefined') {
                Weglot.on('initialized', renderNavalChart);
                Weglot.on('languageChanged', renderNavalChart);
            }
        });
    </script>

<div class="chat-container">
    <div class="chat-header">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline; margin-right:8px;">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
            </svg>
            TuClima IA
        </h3>
        <span class="status-dot"></span>
    </div>
    
    <div class="chat-messages" id="chat-box">
        <div class="message bot-msg">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline; margin-right:6px; vertical-align:middle;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            ¡Hola! Soy tu asistente meteorológico. ¿Qué información necesitas consultar hoy?
        </div>
    </div>

    <div class="chat-input-container" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #1e293b; border-top: 1px solid #334155;">
    
    <input type="file" id="file-input" style="display: none;" accept="image/*,.pdf,.csv,.xlsx">
    <button type="button" onclick="document.getElementById('file-input').click()" style="background: none; border: none; cursor: pointer; padding: 8px; color: #94a3b8; transition: 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#94a3b8'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
    </button>

    <div id="file-preview" style="min-width:120px; color:#e2e8f0; font-size:0.95em; font-family:'Poppins',sans-serif;"></div>

    <input type="text" id="user-input" placeholder="Escribir..." style="flex: 1; padding: 12px; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; outline: none; font-family: 'Poppins', sans-serif;">

    <button onclick="enviarMensaje()" style="background: #4ade80; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#22c55e'" onmouseout="this.style.background='#4ade80'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
        Enviar
    </button>
</div>

<script>
    // --- CONFIGURACIÓN AGRO INTELLIGENCE PRO ---

const urlN8N = "http://localhost:5678/webhook/chat"; // URL de Desarrollo local
let sessionId = localStorage.getItem("chatSessionId") || generateUUID();
localStorage.setItem("chatSessionId", sessionId);

// Historial para flechas del teclado
let historialMensajes = [];
let indiceHistorial = -1;

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
}

// 1. GESTIÓN DE FLECHAS (Arriba/Abajo)
document.getElementById("user-input").addEventListener("keydown", (e) => {
    const input = e.target;
    if (e.key === "ArrowUp") {
        if (historialMensajes.length > 0 && indiceHistorial < historialMensajes.length - 1) {
            indiceHistorial++;
            input.value = historialMensajes[historialMensajes.length - 1 - indiceHistorial];
        }
        e.preventDefault();
    } else if (e.key === "ArrowDown") {
        if (indiceHistorial > 0) {
            indiceHistorial--;
            input.value = historialMensajes[historialMensajes.length - 1 - indiceHistorial];
        } else {
            indiceHistorial = -1;
            input.value = "";
        }
        e.preventDefault();
    } else if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (input.value.trim() !== "") {
            enviarMensaje();
        }
    }
});

// Mostrar archivo seleccionado en la casilla de mensaje
document.getElementById("file-input").addEventListener("change", function() {
    const file = this.files[0];
    const preview = document.getElementById("file-preview");
    if (file) {
        let icon = '';
        if (file.type.startsWith('image/')) {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>';
        } else if (file.type === 'application/pdf') {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
        } else if (file.type.includes('excel') || file.name.match(/\.(xlsx|xls|csv)$/i)) {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><rect x="7" y="7" width="2" height="2"/><rect x="13" y="7" width="2" height="2"/><rect x="7" y="13" width="2" height="2"/><rect x="13" y="13" width="2" height="2"/></svg>';
        } else {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
        }
        preview.innerHTML = '<span style="display:flex; align-items:center; gap:6px;">' + icon + '<span>' + file.name + '</span></span>';
    } else {
        preview.innerHTML = '';
    }
});

// 2. ENVÍO DE MENSAJES Y ARCHIVOS
async function enviarMensaje() {

    const input = document.getElementById("user-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const chatBox = document.getElementById("chat-box");
    const texto = input.value.trim();
    const archivo = fileInput.files[0];

    if (!texto && !archivo) return;

    // Guardar en historial
    if (texto) {
        historialMensajes.push(texto);
        indiceHistorial = -1;
    }

    // Mostrar en UI
    let icon = '';
    if (archivo) {
        if (archivo.type.startsWith('image/')) {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>';
        } else if (archivo.type === 'application/pdf') {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="8" y="16" font-size="8" font-weight="bold" fill="currentColor">PDF</text></svg>';
        } else if (archivo.type.includes('excel') || archivo.name.match(/\.(xlsx|xls|csv)$/i)) {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><rect x="7" y="7" width="2" height="2"/><rect x="13" y="7" width="2" height="2"/><rect x="7" y="13" width="2" height="2"/><rect x="13" y="13" width="2" height="2"/></svg>';
        } else {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
        }
    }
    chatBox.innerHTML += `<div class=\"message user-msg\"><b>Tú:</b> ${texto} ${archivo ? `<br>${icon} <i>Archivo: ${archivo.name}</i>` : ''}</div>`;
    input.value = "";
    filePreview.innerHTML = '';
    chatBox.scrollTop = chatBox.scrollHeight;

    // Animación de espera de IA
    const typingId = 'ia-typing';
    if (!document.getElementById(typingId)) {
        chatBox.innerHTML += `<div class=\"chat-typing\" id=\"${typingId}\"><b>IA:</b> <span class=\"dot-typing\"><span></span><span></span><span></span></span></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    try {
        const formData = new FormData();
        formData.append("chatInput", texto);
        formData.append("sessionId", sessionId);
        if (archivo) {
            formData.append("data00", archivo); 
        }

        const respuesta = await fetch(urlN8N, {
            method: "POST",
            body: formData 
        });

        const datos = await respuesta.json();
        
        // --- AQUÍ ESTÁ EL CAMBIO CLAVE ---
        let respuestaIA = datos.output || "Procesado correctamente.";
        
        // Buscamos si hay un formato [Texto](Enlace) y lo convertimos a un link con clase de botón profesional
        const respuestaIAConLinks = respuestaIA.replace(
            /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
            '<a href="$2" target="_blank" class="download-link">$1</a>'
        );

        // Eliminar animación de espera
        const typingDiv = document.getElementById(typingId);
        if (typingDiv) typingDiv.remove();

        chatBox.innerHTML += `<div class=\"message bot-msg\"><b>IA:</b> ${respuestaIAConLinks}</div>`;
        // --------------------------------
        
        fileInput.value = ""; 
    } catch (error) {
        // Eliminar animación de espera
        const typingDiv = document.getElementById(typingId);
        if (typingDiv) typingDiv.remove();
        chatBox.innerHTML += `<div class=\"message bot-msg\" style=\"color:red;\">⚠️ Error de conexión.</div>`;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>

</body>
</html>