<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title class="notranslate">Sala de Situación | TuClima Radar</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body, html { 
            width: 100%; height: 100%; 
            overflow: hidden; 
            background-color: #020617; 
            font-family: 'Rajdhani', sans-serif; 
        }

        /* IFRAME FULL SCREEN */
        #fondo-mapa {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
    z-index: 1; border: none;
    background-color: #020617; /* Fondo oscuro por si tarda en cargar */
}

        /* BARRA SUPERIOR */
        .top-bar {
            position: fixed; top: 0; left: 0; right: 0;
            height: 80px;
            background: rgba(2, 6, 23, 0.95); 
            border-bottom: 1px solid #1e3a8a;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px;
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .brand { 
            color: #fff; font-size: 1.4rem; font-weight: bold; 
            display: flex; align-items: center; gap: 10px; 
            min-width: 200px;
        }
        .brand span { color: #06b6d4; text-transform: uppercase; letter-spacing: 2px; }

        /* CONTENEDOR DE BOTONES (SCROLLABLE) */
        .controls-wrapper {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            overflow-x: auto; /* Permite scroll si hay muchos botones */
            padding: 0 10px;
        }

        .controls { 
            display: flex; gap: 8px; 
            background: rgba(255,255,255,0.05); 
            padding: 5px; border-radius: 8px; border: 1px solid #1e3a8a; 
        }

        /* BOTONES */
        .btn-layer {
            background: transparent; border: none; color: #94a3b8;
            padding: 8px 12px; border-radius: 6px; cursor: pointer;
            font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.95rem;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.2s; white-space: nowrap;
        }
        .btn-layer:hover { color: #fff; background: rgba(255,255,255,0.1); }
        .btn-layer.active { background: #06b6d4; color: #000; box-shadow: 0 0 15px rgba(6, 182, 212, 0.4); }

        .btn-exit {
            color: #ef4444; text-decoration: none; font-weight: bold; 
            border: 1px solid #ef4444; padding: 8px 15px; border-radius: 6px;
            transition: 0.3s; min-width: 80px; text-align: center;
        }
        .btn-exit:hover { background: #ef4444; color: #fff; }

        /* RESPONSIVE */
        @media (max-width: 1000px) {
            .top-bar { height: auto; flex-direction: column; padding: 10px; gap: 10px; }
            .controls-wrapper { width: 100%; justify-content: flex-start; }
            .brand { justify-content: center; }
        }
    </style>

<script type="text/javascript" src="https://cdn.weglot.com/weglot.min.js"></script>
    <script>
        Weglot.initialize({
            api_key: 'wg_169c193b22e7a117be85a2f56113ab415', // <--- TU LLAVE REAL
            hide_switcher: true,         // Oculta el botón estándar (usaremos el nuestro)
            auto_switch: true            // Detecta idioma automático
        });
    </script>

</head>
<body>

    <div class="top-bar">
        <div class="brand">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg>
            <div>SALA DE <span>SITUACIÓN</span></div>
        </div>

        <div class="controls-wrapper">
            <div class="controls">
                <button onclick="cambiarCapa('wind', this)" class="btn-layer active">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path></svg>
                    Viento
                </button>
                
                <button onclick="cambiarCapa('gust', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2v4M10 2v4M18 14h4M6 14H2M14 22v-4M10 22v-4M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8z"/></svg>
                    Ráfagas
                </button>

                <button onclick="cambiarCapa('rain', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"/><line x1="12" y1="15" x2="12" y2="23"/><line x1="8" y1="13" x2="8" y2="21"/><line x1="16" y1="13" x2="16" y2="21"/></svg>
                    Lluvia
                </button>

                <button onclick="cambiarCapa('thunder', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
                    Tormentas
                </button>

                <button onclick="cambiarCapa('temp', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path></svg>
                    Temp
                </button>

                <button onclick="cambiarCapa('waves', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12h20M2 17h20M2 7h20"/></svg>
                    Olas
                </button>

                <button onclick="cambiarCapa('currents', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/></svg>
                    Corrientes
                </button>

                <button onclick="cambiarCapa('pressure', this)" class="btn-layer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M16.2 7.8l-2.1 6.3-6.3 2.1 2.1-6.3z"/></svg>
                    Presión
                </button>

                <button id="btnDatos" onclick="toggleTabla(this)" class="btn-layer" style="border: 1px solid #facc15; color: #facc15;">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/><path d="M9 3v18"/></svg>
    DATOS
</button>

            </div>
        </div>

        <a href="/" class="btn-exit">✕ SALIR</a>
    </div>

    <iframe id="fondo-mapa"
    src="https://embed.windy.com/embed2.html?lat={{ lat|default:'-34.6' }}&lon={{ lon|default:'-58.4' }}&width=1920&height=1080&zoom=5&level=surface&overlay=wind&product=ecmwf&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1"
    frameborder="0">
</iframe>

    <script>
        function cambiarCapa(capa, btn) {
            var iframe = document.getElementById('fondo-mapa');
            // Regex para cambiar la capa sin romper el resto de la URL
            var url = iframe.src.replace(/overlay=[^&]+/, 'overlay=' + capa);
            iframe.src = url;

            // Gestión de botones activos
            document.querySelectorAll('.btn-layer').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

    
    // 1. CAPTURA DE COORDENADAS (Corrección de Coma a Punto)
    // Django a veces pone coma (-34,6) y Windy necesita punto (-34.6)
    var rawLat = "{{ lat|default:'-34.60' }}";
    var rawLon = "{{ lon|default:'-58.38' }}";
    
    // Forzamos el formato con punto para que no falle el mapa
    const baseLat = rawLat.toString().replace(',', '.');
    const baseLon = rawLon.toString().replace(',', '.');

    // Función para cambiar capas
    function cambiarCapa(capa, btn) {
        var iframe = document.getElementById('fondo-mapa');
        var currentSrc = iframe.src;
        var newSrc = currentSrc.replace(/overlay=[^&]+/, 'overlay=' + capa);
        iframe.src = newSrc;

        document.querySelectorAll('.btn-layer').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Mantener el botón DATOS encendido si corresponde
        const btnDatos = document.getElementById('btnDatos');
        if (btnDatos && iframe.src.includes('detailLat')) {
            btnDatos.classList.add('active');
            btnDatos.style.background = '#facc15';
            btnDatos.style.color = '#000';
        }
    }

    // Función INTERRUPTOR DE TABLA
    function toggleTabla(btn) {
        var iframe = document.getElementById('fondo-mapa');
        var src = iframe.src;

        if (src.indexOf('detailLat') > -1) {
            // CERRAR TABLA
            var newSrc = src
                .replace(/&detailLat=[^&]*/, '')
                .replace(/&detailLon=[^&]*/, '')
                .replace(/&detail=true/, '');
            iframe.src = newSrc;

            // Apagar visualmente
            btn.classList.remove('active');
            btn.style.background = 'transparent';
            btn.style.color = '#facc15';
        } else {
            // ABRIR TABLA (Usando las coordenadas corregidas con punto)
            var params = `&detailLat=${baseLat}&detailLon=${baseLon}&detail=true`;
            iframe.src = src + params;

            // Encender visualmente
            btn.classList.add('active');
            btn.style.background = '#facc15';
            btn.style.color = '#000';
        }
    }
</script>
</body>
</html>