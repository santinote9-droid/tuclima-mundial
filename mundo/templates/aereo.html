<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flight Deck | Pilot Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Animaci√≥n de espera para la IA */
        .chat-typing {
            color: #94a3b8;
            font-style: italic;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 24px;
        }
        .dot-typing {
            display: inline-block;
            width: 30px;
            text-align: left;
        }
        .dot-typing span {
            display: inline-block;
            width: 6px;
            height: 6px;
            margin-right: 2px;
            background: #94a3b8;
            border-radius: 50%;
            opacity: 0.5;
            animation: blink 1.4s infinite both;
        }
        .dot-typing span:nth-child(2) { animation-delay: 0.2s; }
        .dot-typing span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0.5; }
            40% { opacity: 1; }
        }
    /* CHAT TuClima IA - Tipograf√≠a profesional estilo Vercel/GitHub */
    .chat-container {
        width: 100%;
        min-height: 600px;
        margin: 20px 0;
        background: #1e293b;
        border: 1px solid #334155;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .chat-header {
        background: #0f172a;
        padding: 18px 24px;
        border-bottom: 1px solid #334155;
        display: flex;
        align-items: center;
        gap: 10px;
        color: #e2e8f0;
    }

    .chat-header h3 {
        margin: 0;
        color: #e2e8f0;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: -0.3px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .status-dot {
        height: 10px; width: 10px;
        background-color: #4ade80;
        border-radius: 50%;
        display: inline-block;
        box-shadow: 0 0 5px #4ade80;
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 15px;
        background-color: #1e293b;
        color: #e2e8f0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .message {
        max-width: 80%;
        padding: 14px 20px;
        border-radius: 10px;
        font-size: 15px;
        line-height: 1.5;
        font-weight: 500;
        letter-spacing: -0.2px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }

    .bot-msg {
        background-color: #334155;
        color: #e2e8f0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }
    .user-msg {
        background-color: #3b82f6;
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .chat-input-area {
        padding: 18px;
        background: #0f172a;
        border-top: 1px solid #334155;
        display: flex;
        gap: 10px;
    }

    .chat-input-area input[type="text"] {
        flex: 1;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #334155;
        background: #1e293b;
        color: #e2e8f0;
        font-size: 15px;
        font-weight: 500;
        outline: none;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        transition: border 0.2s;
        letter-spacing: -0.2px;
    }
    .chat-input-area input[type="text"]:focus {
        border: 1.5px solid #3b82f6;
    }

    .chat-input-area button {
        padding: 12px 25px;
        background: #3b82f6;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        font-size: 15px;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        transition: background 0.2s, color 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        letter-spacing: -0.2px;
    }
    .chat-input-area button:hover {
        background: #2563eb;
        color: #fff;
    }

    /* Bot√≥n de descarga de archivos en el chat */
    .chat-messages a.download-link {
        display: inline-block;
        background: #3b82f6;
        color: #fff !important;
        padding: 10px 22px;
        border-radius: 6px;
        font-weight: 600;
        text-decoration: none !important;
        box-shadow: 0 2px 8px rgba(59,130,246,0.08);
        margin-top: 8px;
        margin-bottom: 2px;
        transition: background 0.2s, box-shadow 0.2s;
        border: none;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        letter-spacing: -0.2px;
    }
    .chat-messages a.download-link:hover {
        background: #1e293b;
        color: #3b82f6 !important;
        box-shadow: 0 4px 16px rgba(59,130,246,0.18);
        border: 1.5px solid #3b82f6;
    }
</style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ========================================================= */
        /* 1. CORE STYLES & DEEP BLUE THEME                          */
        /* ========================================================= */
        body {
            background-color: #020617; /* Fondo Ultra Oscuro */
            color: #f8fafc;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            background-image: radial-gradient(circle at 50% -10%, #172554 0%, #020617 60%);
            min-height: 100vh;
        }

        /* ICONOS SVG GEN√âRICOS */
        .icon-svg {
            width: 24px; height: 24px;
            stroke: currentColor; stroke-width: 2;
            stroke-linecap: round; stroke-linejoin: round; fill: none;
        }

        /* ========================================================= */
        /* 2. ENCABEZADO (HEADER) - GRID LAYOUT                      */
        /* ========================================================= */
        .cockpit-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Izq - Centro - Der */
            align-items: center;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            padding: 15px 30px;
            border-bottom: 1px solid #1e3a8a;
            margin-bottom: 30px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.3);
        }

        /* HEADER IZQUIERDA */
        .header-left .brand { 
            font-size: 1.5rem; font-weight: 800; color: #fff; 
            display: flex; align-items: center; gap: 10px; text-shadow: 0 0 20px rgba(59,130,246,0.5);
        }
        .badge {
            background: rgba(37, 99, 235, 0.2); color: #60a5fa; border: 1px solid #3b82f6;
            padding: 2px 8px; border-radius: 4px; font-size: 0.6em; letter-spacing: 1px;
        }
        .header-left .coords { 
            color: #94a3b8; font-family: 'Consolas', monospace; font-size: 0.85em; margin-top: 5px; 
        }

        /* HEADER CENTRO (Bot√≥n Calc) */
        .header-center { display: flex; justify-content: center; }
        .btn-calc-main {
            background: #020617; border: 1px solid #facc15; color: #facc15;
            padding: 10px 25px; border-radius: 8px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; gap: 10px; transition: 0.3s;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.1);
        }
        .btn-calc-main:hover { 
            background: #facc15; color: #000; box-shadow: 0 0 25px rgba(250, 204, 21, 0.4); 
        }

        /* HEADER DERECHA */
        .header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        .zulu-box { font-family: 'Consolas', monospace; color: #fff; font-size: 1.6em; font-weight: bold; line-height: 1; }
        .user-box { display: flex; gap: 15px; align-items: center; margin-top: 5px; font-size: 0.85em; color: #94a3b8; }
        .btn-logout { 
            color: #ef4444; text-decoration: none; font-weight: bold; 
            border: 1px solid #ef4444; padding: 2px 8px; border-radius: 4px; 
        }
        .btn-logout:hover { background: #ef4444; color: #fff; }

        /* TIRA METAR */
        .metar-strip {
            background: #0b1120; color: #facc15; font-family: 'Consolas', monospace;
            padding: 15px 20px; border-left: 5px solid #facc15; margin-bottom: 35px;
            overflow-x: auto; white-space: nowrap; font-size: 1.1rem;
            border-radius: 8px; border: 1px solid #1e293b;
        }

        /* ========================================================= */
        /* 3. DASHBOARD GRID (PANELES PEQUE√ëOS)                      */
        /* ========================================================= */
        .grid-cockpit {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-bottom: 50px;
        }
        @media (max-width: 1200px) { .grid-cockpit { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 700px) { .grid-cockpit { grid-template-columns: 1fr; } }

        /* TARJETA / PANEL */
        .panel {
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid #1e3a8a; border-radius: 16px; 
            padding: 25px; min-height: 220px;
            display: flex; flex-direction: column; justify-content: space-between;
            cursor: pointer; transition: all 0.3s; position: relative; backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .panel:hover {
            background: rgba(30, 58, 138, 0.2); border-color: #3b82f6; transform: translateY(-5px);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.2);
        }
        
        .info-icon { position: absolute; top: 20px; right: 20px; color: #334155; transition: 0.3s; }
        .panel:hover .info-icon { color: #60a5fa; }

        .p-head { 
            color: #94a3b8; font-size: 0.85em; font-weight: 700; letter-spacing: 2px; 
            text-transform: uppercase; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; 
        }
        .p-main { 
            text-align: center; font-size: 3.5em; font-weight: 800; margin: 5px 0 15px 0; 
            color: #fff; line-height: 1; letter-spacing: -1px; text-shadow: 0 0 30px rgba(255,255,255,0.1); 
        }
        .p-foot { 
            display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.05); 
            padding-top: 15px; font-size: 0.95em; margin-top: auto; 
        }
        .lbl { font-size: 0.7em; color: #64748b; display: block; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        .val { font-weight: 700; color: #e2e8f0; font-size: 1.1em; font-family: 'Consolas', monospace; }

        /* RADAR ANIMATION */
        @keyframes pulse-radar {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .radar-active { animation: pulse-radar 2s infinite; border-color: #ef4444 !important; background: rgba(69, 10, 10, 0.3) !important; }

        /* ========================================================= */
        /* 4. PANEL GR√ÅFICO GRANDE (FULL WIDTH)                      */
        /* ========================================================= */
        .panel-large {
            background: #0b1120; border: 1px solid #1e3a8a; border-radius: 16px;
            padding: 0; margin-bottom: 50px; width: 100%;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5); overflow: hidden;
        }
        .panel-header-large {
            background: rgba(30, 58, 138, 0.2); padding: 15px 30px; border-bottom: 1px solid #1e3a8a;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;
        }
        .panel-title {
            color: #fff; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 15px;
            text-transform: uppercase; letter-spacing: 2px;
        }
        
        /* Botones Altitud */
        .alt-selector { display: flex; background: #020617; border-radius: 8px; border: 1px solid #1e3a8a; overflow: hidden; }
        .btn-alt {
            background: transparent; border: none; color: #94a3b8; padding: 8px 16px; 
            font-family: 'Consolas', monospace; font-weight: bold; cursor: pointer; border-right: 1px solid #1e3a8a;
        }
        .btn-alt:last-child { border-right: none; }
        .btn-alt:hover { background: rgba(59, 130, 246, 0.2); color: #fff; }
        .btn-alt.active { background: #3b82f6; color: #fff; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); }

        .btn-download {
            background: transparent; border: 1px solid #3b82f6; color: #3b82f6; padding: 8px 16px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px;
        }
        .btn-download:hover { background: #3b82f6; color: #fff; }

        .chart-wrapper {
            padding: 25px; height: 450px; width: 100%; position: relative;
            background: radial-gradient(circle at 50% 50%, #172554 0%, #0b1120 70%);
        }

        /* ========================================================= */
        /* 5. MODALES (VENTANAS EMERGENTES)                          */
        /* ========================================================= */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(2, 6, 23, 0.96); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: #0b1120; padding: 50px; border-radius: 20px; width: 90%; max-width: 950px;
            border: 1px solid #1e3a8a; box-shadow: 0 0 100px rgba(59, 130, 246, 0.15);
            max-height: 90vh; overflow-y: auto; position: relative;
        }
        .btn-close {
            position: absolute; top: 30px; right: 30px; font-size: 2.5rem; color: #475569; 
            cursor: pointer; background: none; border: none; transition: 0.2s; line-height: 0.5;
        }
        .btn-close:hover { color: #ef4444; }

        .didactic-box {
            background: rgba(30, 58, 138, 0.1); padding: 25px; border-radius: 10px; margin-top: 30px;
            border-left: 4px solid #3b82f6; border: 1px solid #1e3a8a;
        }
        .didactic-title { font-weight: bold; color: #60a5fa; margin-bottom: 10px; font-size: 1.1em; display: block; }
        .didactic-text { color: #cbd5e1; line-height: 1.7; margin: 0; }

        /* Estilos Tabla Modal */
        .data-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 30px; background: #020617; border-radius: 10px; border: 1px solid #1e3a8a; overflow: hidden; }
        .data-table th { background: #172554; color: #fff; padding: 18px; text-align: left; font-size: 0.85em; }
        .data-table td { border-bottom: 1px solid #1e293b; padding: 18px; color: #cbd5e1; }

        /* Estilos Calculadora */
        .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .calc-input, .calc-select {
            background: #020617; border: 1px solid #334155; color: #fff; padding: 15px; width: 100%; border-radius: 8px; font-size: 1.2rem;
        }
    </style>

<script type="text/javascript" src="https://cdn.weglot.com/weglot.min.js"></script>
    <script>
        Weglot.initialize({
            api_key: 'wg_169c193b22e7a117be85a2f56113ab415', // <--- TU LLAVE REAL
            hide_switcher: true,         // Oculta el bot√≥n est√°ndar (usaremos el nuestro)
            auto_switch: true            // Detecta idioma autom√°tico
        });
    </script>
</head>
<body>

    <div id="google_translate_element" style="display:none;"></div>
    <script src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    <script>
        function googleTranslateElementInit() { new google.translate.TranslateElement({ pageLanguage: 'es', includedLanguages: 'en,fr,it,pt,de', autoDisplay: false }, 'google_translate_element'); }
        window.addEventListener('load', function() {
            var lang = (navigator.language || navigator.userLanguage).split('-')[0];
            if (lang !== 'es') { setTimeout(function() { var s = document.querySelector('select.goog-te-combo'); if(s){s.value=lang;s.dispatchEvent(new Event('change'));}}, 1000); }
        });
    </script>
    <style>.goog-te-banner-frame{display:none!important}body{top:0!important}</style>

    <div class="cockpit-header">
        
        <div class="header-left">
            <div class="brand">
                <svg class="icon-svg" style="color:#3b82f6; width:28px;" viewBox="0 0 24 24"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.3c.4-.2.6-.6.5-1.1z"/></svg>
                FLIGHT DECK <span class="badge">PRO</span>
            </div>
            <div class="coords">Lat: {{ lat|floatformat:2 }} | Lon: {{ lon|floatformat:2 }}</div>
        </div>

        <div class="header-center">
            <button class="btn-calc-main" onclick="openModal('modCalc')">
                <svg class="icon-svg" style="width:20px" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></svg>
                CALCULADORA E6B
            </button>
        </div>

        <div class="header-right">
            <div class="zulu-box">{{ metar.hora }} <span style="font-size:0.5em; color:#64748b">ZULU</span></div>
            
            <div class="user-box">
                {% if user.is_authenticated %}
                    <span style="color:#94a3b8; font-size:0.9em; margin-right:15px;">CMD: {{ user.username }}</span>
                    
                    <a href="/" class="btn-logout">‚úï SALIR</a>
                {% else %}
                    <a href="/login/" style="color:#3b82f6;">INGRESAR</a>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="metar-strip">
        <strong>METAR:</strong> {{ metar.raw }}
    </div>

    <div class="grid-cockpit">

        <div class="panel" onclick="openModal('modCat')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg></div>
            <div class="p-head"><svg class="icon-svg" style="width:18px;" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/></svg> VUELO</div>
            <div class="p-main" style="color: {{ categoria.color }}">{{ categoria.codigo }}</div>
            <div class="p-foot">
                <div><span class="lbl">VISIBILIDAD</span><span class="val">{{ categoria.vis }} km</span></div>
                <div style="text-align: right;"><span class="lbl">TECHO</span><span class="val">{{ categoria.techo }} <small>ft</small></span></div>
            </div>
        </div>

        <div class="panel" onclick="openModal('modAlt')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/></svg></div>
            <div class="p-head"><svg class="icon-svg" style="width:18px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> QNH / DENSIDAD</div>
            <div class="p-main">{{ altimetria.qnh }} <small style="font-size:0.4em; color:#64748b">hPa</small></div>
            <div class="p-foot">
                <div><span class="lbl">DENSITY ALT</span><span class="val">{{ altimetria.density_alt }} <small>ft</small></span></div>
                <div style="text-align: right;"><span class="lbl">SPREAD</span><span class="val" style="color:#22c55e">{{ altimetria.spread }}¬∞C</span></div>
            </div>
        </div>

        <div class="panel" onclick="openModal('modViento')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/></svg></div>
            <div class="p-head"><svg class="icon-svg" style="width:18px;" viewBox="0 0 24 24"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"/></svg> VIENTO PISTA</div>
            <div class="p-main" style="color:#3b82f6">{{ viento.kt }} <small style="font-size:0.4em">KT</small></div>
            <div class="p-foot">
                <div><span class="lbl">DIRECCI√ìN</span><span class="val">{{ viento.dir }}¬∞</span></div>
                <div style="text-align: right;"><span class="lbl">R√ÅFAGAS</span><span class="val" style="color:#facc15">{{ viento.rafagas }} KT</span></div>
            </div>
        </div>

        <div class="panel" onclick="openModal('modNubes')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/></svg></div>
            <div class="p-head"><svg class="icon-svg" style="width:18px;" viewBox="0 0 24 24"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg> CIELO</div>
            <div class="p-main" style="color:#cbd5e1">{{ nubes.estado }}</div>
            <div class="p-foot">
                <div><span class="lbl">COBERTURA</span><span class="val">{{ nubes.cobertura }}</span></div>
                <div style="text-align: right;"><span class="lbl">BASE</span><span class="val">{{ nubes.base }} <small>ft</small></span></div>
            </div>
        </div>

        <div class="panel" style="border-left: 4px solid {{ riesgos.color }}" onclick="openModal('modHaz')">
            <div class="info-icon" style="color:{{ riesgos.color }}"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></svg></div>
            <div class="p-head" style="color:{{ riesgos.color }}">RIESGOS</div>
            <div class="p-main" style="font-size:1.8em; color: {{ riesgos.color }}; margin-top:30px;">{{ riesgos.msg }}</div>
            <div class="p-foot" style="margin-top:auto">
                <div><span class="lbl">ISO 0¬∞</span><span class="val" style="color:#60a5fa">{{ riesgos.iso_0 }}</span></div>
                <div style="text-align: right;"><span class="lbl">SHEAR</span><span class="val" style="color:#facc15">{{ riesgos.shear }}</span></div>
            </div>
        </div>

        <div class="panel" onclick="openModal('modVientoAlt')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></div>
            <div class="p-head">EN ALTURA</div>
            <div class="p-main" style="color:#facc15">{{ viento_altura.dir }}¬∞<span style="color:#fff; font-size:0.5em">/</span>{{ viento_altura.kt }}</div>
            <div style="text-align:center; color:#94a3b8; font-size:0.9em; margin-top:-15px">Nivel FL050 (5.000 ft)</div>
        </div>

        <div class="panel" onclick="openModal('modAstro')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/></svg></div>
            <div class="p-head">ASTRO</div>
            <div class="p-main" style="color:#fbbf24">{{ astro.luz }}</div>
            <div class="p-foot">
                <div><span class="lbl">SALE</span><span class="val">{{ astro.sale }}</span></div>
                <div style="text-align: right;"><span class="lbl">PUESTA</span><span class="val">{{ astro.puesta }}</span></div>
            </div>
        </div>

        <div class="panel" onclick="openModal('modAmbiente')">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"/></svg></div>
            <div class="p-head">AMBIENTE</div>
            <div class="p-main" style="color:#fff">{{ ambiente.temp }}¬∞C</div>
            <div class="p-foot">
                <div><span class="lbl">HUMEDAD</span><span class="val" style="color:#60a5fa">{{ ambiente.humedad }}%</span></div>
                <div style="text-align: right;"><span class="lbl">SENSACI√ìN</span><span class="val">{{ ambiente.sensacion }}¬∞C</span></div>
            </div>
        </div>

        <div class="panel {% if radar.estado != 'NORMAL' %}radar-active{% endif %}" onclick="openModal('modRadar')" style="border-left: 4px solid {{ radar.color }}">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 12A10 10 0 0 0 12 2v10z"/><circle cx="12" cy="12" r="10"/></svg></div>
            <div class="p-head">TORMENTAS</div>
            <div class="p-main" style="color: {{ radar.color }}; font-size: 1.8em; margin-top:30px;">{{ radar.estado }}</div>
            <div class="p-foot" style="margin-top:auto">
                <div style="width:100%; text-align:center;"><span class="lbl">AVISO</span><span class="val" style="color:#fff; font-size:0.9em">{{ radar.aviso }}</span></div>
            </div>
        </div>

        <div class="panel" onclick="openModal('modVis')" style="grid-column: 1 / -1;">
            <div class="info-icon"><svg class="icon-svg" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div>
            <div class="p-head">VISIBILIDAD HORIZONTAL</div>
            <div class="p-main" style="color: {{ visibilidad_panel.color }}">{{ visibilidad_panel.km }} <small>km</small></div>
            <div style="text-align:center; color: #94a3b8; font-size:0.9em;">{{ visibilidad_panel.estado }}</div>
        </div>

    </div> <div class="panel-large">
        <div class="panel-header-large">
            <div class="panel-title">
                <svg class="icon-svg" style="color:#60a5fa" viewBox="0 0 24 24"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                <div style="display:flex; flex-direction:column; line-height:1.2;">
                    <span>PERFIL DE VUELO</span>
                    <span id="chartSubTitle" style="font-size:0.5em; color:#64748b; font-weight:600; letter-spacing:1px; margin-top:3px;">NIVEL: SUPERFICIE (SFC)</span>
                </div>
            </div>
            
            <div class="alt-selector">
        <button class="btn-alt active" onclick="updateAltitude('SFC', this)">SFC</button>
        <button class="btn-alt" onclick="updateAltitude('2000', this)">2000ft</button>
        <button class="btn-alt" onclick="updateAltitude('5000', this)">5000ft</button>
        <button class="btn-alt" onclick="updateAltitude('10000', this)">10000ft</button> 
        <button class="btn-alt" onclick="updateAltitude('30000', this)">FL300</button> </div>
            
            <button class="btn-download" onclick="downloadChart()">
                <svg class="icon-svg" style="width:18px; height:18px;" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                DESCARGAR
            </button>
        </div>
        <div class="chart-wrapper">
            <canvas id="aereoChart"></canvas>
        </div>
    </div>

    <style>
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .info-card { background: rgba(30, 58, 138, 0.15); padding: 15px; border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.2); }
        .info-title { color: #60a5fa; font-size: 0.8em; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .info-value { color: #fff; font-weight: bold; font-size: 1.1em; }
        .pro-tip { margin-top: 15px; padding: 12px; border-left: 3px solid #facc15; background: rgba(250, 204, 21, 0.05); color: #cbd5e1; font-size: 0.9em; font-style: italic; }
        .rule-box { margin-top: 10px; font-size: 0.85em; color: #94a3b8; display: flex; gap: 10px; align-items: center; }
        .mini-table { width: 100%; border-collapse: collapse; font-size: 0.85em; margin-top: 10px; }
        .mini-table th { text-align: left; color: #64748b; border-bottom: 1px solid #334155; padding: 5px; }
        .mini-table td { color: #e2e8f0; padding: 5px; border-bottom: 1px solid rgba(51, 65, 85, 0.3); }
    </style>

    <div id="modCat" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modCat')">√ó</button>
            <h2 style="color:{{ categoria.color }}; border-bottom:1px solid #334155; padding-bottom:10px;">
                CATEGOR√çA DE VUELO: {{ categoria.codigo }}
            </h2>
            
            <div style="display:flex; gap:20px; margin-top:20px;">
                <div style="background:#020617; padding:20px; border-radius:12px; flex:1; border:1px solid #1e3a8a; text-align:center;">
                    <span class="lbl">VISIBILIDAD REINANTE</span>
                    <strong style="font-size:2em; color:#fff">{{ categoria.vis }} km</strong>
                </div>
                <div style="background:#020617; padding:20px; border-radius:12px; flex:1; border:1px solid #1e3a8a; text-align:center;">
                    <span class="lbl">TECHO (BKN/OVC)</span>
                    <strong style="font-size:2em; color:#fff">{{ categoria.techo }} ft</strong>
                </div>
            </div>

            
            <div style="display: flex; gap: 20px; margin-top: 20px;">
                <div class="info-card" style="flex: 1; margin-top: 5px; margin-bottom: 10px; display: block; text-align: center; padding: 12px 15px;">
                    <span class="info-title" style="font-size: 0.75em;">REGLAS {{ categoria.codigo }}</span>
                    <ul style="margin:0; padding-left:20px; color:#cbd5e1; font-size:0.9em;" id="reglasLista">
                        <li><strong>VFR (Visual):</strong> <span class="techo-label">Techo</span> > 3000ft / Vis > 8km.</li>
                        <li><strong>MVFR (Marginal):</strong> <span class="techo-label">Techo</span> 1000-3000ft / Vis 5-8km.</li>
                        <li><strong>IFR (Instrumental):</strong> <span class="techo-label">Techo</span> < 1000ft / Vis < 5km.</li>
                        <li><strong>LIFR (Low IFR):</strong> <span class="techo-label">Techo</span> < 500ft / Vis < 1.6km.</li>
                    </ul>
                </div>
                <div class="info-card" style="flex: 1; margin-top: 5px; margin-bottom: 10px; display: block; text-align: center; padding: 12px 15px;">
                    <span class="info-title" style="font-size: 0.75em;">ACCI√ìN REQUERIDA</span>
                    <p style="margin: 5px 0 0 0; color:#fff; font-size: 0.85em;">
                        {% if categoria.codigo == 'LIFR' or categoria.codigo == 'IFR' %}
                            ‚õî <strong>PLAN DE VUELO IFR OBLIGATORIO.</strong> Verifique m√≠nimos de aproximaci√≥n y alternativos.
                        {% elif categoria.codigo == 'MVFR' %}
                            ‚ö†Ô∏è <strong>PRECAUCI√ìN.</strong> Mantenga contacto visual con el terreno. Posible cierre de condiciones.
                        {% else %}
                            ‚úÖ <strong>OPERACI√ìN NORMAL.</strong> Mantenga vigilancia visual y escaneo de tr√°fico.
                        {% endif %}
                    </p>
                </div>
            </div>
        
            <script>
                function updateTechoLabel() {
                    const techoLabel = typeof Weglot !== 'undefined' && Weglot.getCurrentLang() === 'en' ? 'Ceiling' : 'Techo';
                    document.querySelectorAll('.techo-label').forEach(el => {
                        el.textContent = techoLabel;
                    });
                }
                
                document.addEventListener("DOMContentLoaded", updateTechoLabel);
                
                if (typeof Weglot !== 'undefined') {
                    Weglot.on('languageChanged', updateTechoLabel);
                }
            </script>
                
</div>
</div>

    <div id="modAlt" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modAlt')">√ó</button>
            <h2>PERFORMANCE Y ALTIMETR√çA</h2>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;">
                <div style="background:#020617; padding:15px; border-radius:12px; border:1px solid #1e3a8a">
                    <span class="lbl">QNH (ALTIMETER)</span>
                    <strong style="font-size:1.8em; color:#fff">{{ altimetria.qnh }} hPa</strong>
                    <div style="font-size:0.8em; color:#94a3b8; margin-top:5px;">Est√°ndar: 1013.25 hPa</div>
                </div>
                <div style="background:#020617; padding:15px; border-radius:12px; border:1px solid #1e3a8a">
                    <span class="lbl">DENSITY ALTITUDE (DA)</span>
                    <strong style="font-size:1.8em; color:#fff">{{ altimetria.density_alt }} ft</strong>
                    <div style="font-size:0.8em; color:#94a3b8; margin-top:5px;">Lo que el avi√≥n "siente"</div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">IMPACTO EN DESPEGUE</span>
                    <table class="mini-table">
                        <tr><td>Carrera Despegue</td><td style="color:#f43f5e; font-weight:bold;">+15% por cada 1000ft DA</td></tr>
                        <tr><td>R√©gimen Ascenso</td><td style="color:#f43f5e;">-10% por cada 1000ft DA</td></tr>
                    </table>
                </div>
                <div class="info-card">
                    <span class="info-title">REGLA MNEMOT√âCNICA</span>
                    <p style="margin:5px 0; color:#fbbf24; font-weight:bold;">"High to Low, Look out below"</p>
                    <p style="font-size:0.85em; color:#cbd5e1;">Si vuela de zona de Alta Presi√≥n a Baja sin corregir QNH, su altitud real ser√° MENOR a la indicada.</p>
                </div>
            </div>
            
            <div class="pro-tip">
                üí° <strong>Consejo Pro:</strong> Si la Densidad de Altitud supera los 3,000 ft, empobrezca la mezcla antes del despegue para m√°xima potencia (aviones pist√≥n aspirados).
            </div>
        </div>
    </div>

    <div id="modViento" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modViento')">√ó</button>
            <h2>AN√ÅLISIS DE VIENTO EN PISTA</h2>
            
            <div style="text-align:center; margin:20px 0; display:flex; align-items:center; justify-content:center; gap:30px;">
                <div>
                    <div style="font-size:4em; font-weight:800; color:#3b82f6; line-height:1;">{{ viento.kt }}</div>
                    <div style="color:#94a3b8;">NUDOS (KT)</div>
                </div>
                <div style="height:60px; width:1px; background:#334155;"></div>
                <div>
                    <div style="font-size:4em; font-weight:800; color:#fff; line-height:1;">{{ viento.dir }}¬∞</div>
                    <div style="color:#94a3b8;">DIRECCI√ìN</div>
                </div>
            </div>

            <div style="background:rgba(239,68,68,0.15); border:1px solid #ef4444; color:#fca5a5; padding:15px; border-radius:10px; text-align:center; font-weight:bold; margin-bottom:20px;">
                ‚ö†Ô∏è R√ÅFAGAS REPORTADAS: {{ viento.rafagas }} KT
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">C√ÅLCULO VELOCIDAD APROXIMACI√ìN (Vref)</span>
                    <p style="color:#cbd5e1; font-size:0.9em;">Con r√°fagas, a√±ada a su velocidad final:</p>
                    <div style="background:#000; padding:10px; border-radius:5px; margin-top:5px; font-family:monospace; color:#facc15; text-align:center;">
                        Vref + <span id="gust-addition"></span>kt
                    </div>
                    <p style="font-size:0.8em; color:#94a3b8; margin-top:5px;">
                        Gust Factor: {{ viento.rafagas }}kt - {{ viento.kt }}kt = <span id="gust-factor"></span>kt ‚Üí A√±adir <span id="final-addition"></span>kt
                    </p>
                    <script>
                        const gustFactor = {{ viento.rafagas }} - {{ viento.kt }};
                        const addition = Math.round(gustFactor / 2);
                        document.getElementById('gust-factor').textContent = gustFactor;
                        document.getElementById('gust-addition').textContent = addition;
                        document.getElementById('final-addition').textContent = addition;
                    </script>
                </div>
                <div class="info-card">
                    <span class="info-title">COMPONENTES ESTIMADAS</span>
                    <table class="mini-table">
                        <tr><td>30¬∞ Diferencia Pista</td><td>50% Cruzado</td></tr>
                        <tr><td>45¬∞ Diferencia Pista</td><td>70% Cruzado</td></tr>
                        <tr><td>60¬∞ Diferencia Pista</td><td>90% Cruzado</td></tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modNubes" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modNubes')">√ó</button>
            <h2>PERFIL VERTICAL DE NUBES</h2>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nivel (AGL)</th>
                        <th>Cobertura</th>
                        <th>Detalle / Riesgo</th> </tr>
                </thead>
                <tbody>
                    {% for capa in tabla_nubes %}
                    <tr class="data-row">
                        <td style="font-weight:bold; color:#fff;">{{ capa.capa }}</td>
                        <td>
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div style="width:50px; background:#334155; height:6px; border-radius:3px;">
                                    <div style="width:{{ capa.pct }}%; background:{% if capa.pct > 50 %}#ef4444{% else %}#60a5fa{% endif %}; height:6px; border-radius:3px;"></div>
                                </div>
                                {{ capa.pct }}%
                            </div>
                        </td>
                        <td style="color:#cbd5e1; font-size:0.9em;">
                            {{ capa.desc }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="didactic-box">
                <span class="didactic-title">‚òÅÔ∏è Definiciones Clave</span>
                <ul style="color:#cbd5e1; font-size:0.9em; margin:0; padding-left:20px;">
                    <li><strong>Techo (Ceiling):</strong> La capa de nubes m√°s baja reportada como BKN (Broken) o OVC (Overcast).</li>
                    <li><strong>AGL vs MSL:</strong> Los reportes METAR dan altura sobre el terreno (AGL). Sume la elevaci√≥n del aeropuerto para obtener la altitud de vuelo (MSL).</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="modHaz" class="modal-overlay" >
        <div class="modal-content" style="border:2px solid {{ riesgos.color }}">
            <button class="btn-close" onclick="closeModal('modHaz')">√ó</button>
            <h2 style="color:{{ riesgos.color }}">PELIGROS SIGNIFICATIVOS</h2>
            
            <h3 style="text-align:center; font-size:2.5em; margin:20px 0; text-transform:uppercase;">{{ riesgos.msg }}</h3>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div style="background:#020617; padding:20px; border-radius:12px; border:1px solid #1e3a8a">
                    <span class="lbl">NIVEL DE CONGELAMIENTO (ISO 0¬∞)</span>
                    <div style="font-size:2em; color:#60a5fa; font-weight:bold;">{{ riesgos.iso_0 }}</div>
                    <div style="font-size:0.8em; color:#94a3b8;">Altura donde el agua se vuelve hielo.</div>
                </div>
                <div style="background:#020617; padding:20px; border-radius:12px; border:1px solid #1e3a8a">
                    <span class="lbl">√çNDICE DE CIZALLADURA (SHEAR)</span>
                    <div style="font-size:2em; color:#facc15; font-weight:bold;">{{ riesgos.shear }}</div>
                    <div style="font-size:0.8em; color:#94a3b8;">Cambio brusco de viento (turbulencia).</div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">ENGELAMIENTO (ICING)</span>
                    <p style="font-size:0.9em; color:#cbd5e1;">Ocurre en <strong>Humedad Visible</strong> + <strong>Temp < 0¬∞C</strong>.</p>
                    <ul style="font-size:0.85em; color:#94a3b8; padding-left:15px;">
                        <li><strong>Rime:</strong> Opaco, rugoso (estratos).</li>
                        <li><strong>Clear:</strong> Transparente, pesado (c√∫mulos).</li>
                        <li><strong>Acci√≥n:</strong> Cambiar altitud inmediatamente.</li>
                    </ul>
                </div>
                <div class="info-card">
                    <span class="info-title">RECUPERACI√ìN WIND SHEAR</span>
                    <ol style="font-size:0.9em; color:#fff; padding-left:20px; font-weight:bold;">
                        <li>MAX POWER (Potencia M√°xima).</li>
                        <li>PITCH UP (Nariz arriba 15¬∞).</li>
                        <li>NO CONFIG CHANGES (No toque flaps/tren).</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <div id="modVientoAlt" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modVientoAlt')">√ó</button>
            <h2>VIENTOS Y TEMPERATURAS EN ALTURA</h2>
            
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Nivel de Vuelo</th>
                        <th>Direcci√≥n</th>
                        <th>Velocidad</th>
                        <th>Temp / Info</th> </tr>
                </thead>
                <tbody>
                    {% for nivel in tabla_vientos %}
                    <tr class="data-row">
                        <td style="color:#facc15; font-weight:bold;">{{ nivel.lvl }}</td>
                        <td>{{ nivel.dir }}¬∞</td>
                        <td><strong>{{ nivel.kt }} KT</strong></td>
                        <td style="font-size:0.85em; color:#94a3b8;">
                            {{ nivel.efecto }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div class="didactic-box">
                <span class="didactic-title">‚úàÔ∏è Eficiencia de Combustible</span>
                <p class="didactic-text">
                    <strong>Viento de Cola:</strong> Aumenta Ground Speed (GS), reduce consumo por tramo. <br>
                    <strong>Viento de Frente:</strong> Aumenta tiempo de vuelo. Considere altitudes m√°s bajas donde el viento suele ser menor.
                </p>
            </div>
        </div>
    </div>

    <div id="modAstro" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modAstro')">√ó</button>
            <h2>DATOS ASTRON√ìMICOS</h2>
            
            <div style="display:flex; justify-content:space-around; margin:30px 0; background:rgba(0,0,0,0.3); padding:20px; border-radius:15px;">
                <div style="text-align:center">
                    <svg class="icon-svg" style="color:#fbbf24; width:40px; height:40px; margin-bottom:10px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"/><path d="M12 1v2"/><path d="M12 21v2"/><path d="M4.22 4.22l1.42 1.42"/><path d="M18.36 18.36l1.42 1.42"/><path d="M1 12h2"/><path d="M21 12h2"/><path d="M4.22 19.78l1.42-1.42"/><path d="M18.36 5.64l1.42-1.42"/></svg>
                    <br><span class="lbl">SALIDA DEL SOL</span>
                    <strong style="font-size:2.2em; color:#fff">{{ astro.sale }}Z</strong>
                </div>
                <div style="width:1px; background:#334155;"></div>
                <div style="text-align:center">
                    <svg class="icon-svg" style="color:#60a5fa; width:40px; height:40px; margin-bottom:10px;" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <br><span class="lbl">PUESTA DEL SOL</span>
                    <strong style="font-size:2.2em; color:#fff">{{ astro.puesta }}Z</strong>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">VFR NOCTURNO</span>
                    <p style="color:#cbd5e1; font-size:0.9em;">
                        El vuelo VFR diurno termina oficialmente al fin del <strong>Crep√∫sculo Civil Vespertino</strong> (aprox 30 min despu√©s de la puesta).
                    </p>
                </div>
                <div class="info-card">
                    <span class="info-title">ILUSIONES SENSORIALES</span>
                    <p style="color:#cbd5e1; font-size:0.9em;">
                        En aproximaciones con sol de frente (amanecer/atardecer), la visibilidad de la pista se reduce dr√°sticamente. Use instrumentos.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="modAmbiente" class="modal-overlay" >
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modAmbiente')">√ó</button>
            <h2>CONDICIONES AMBIENTALES</h2>
            <div style="text-align:center; margin-bottom:20px;">
                <h3 style="color:#fff; font-size:2em; font-weight:300;">{{ ambiente.desc }}</h3>
            </div>

            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                <div style="background:#020617; padding:20px; border-radius:12px; border:1px solid #1e3a8a; text-align:center;">
                    <span class="lbl">TEMPERATURA</span>
                    <strong style="font-size:2em; color:#fff">{{ ambiente.temp }}¬∞C</strong>
                </div>
                <div style="background:#020617; padding:20px; border-radius:12px; border:1px solid #1e3a8a; text-align:center;">
                    <span class="lbl">HUMEDAD RELATIVA</span>
                    <strong style="font-size:2em; color:#60a5fa">{{ ambiente.humedad }}%</strong>
                </div>
            </div>

            <div class="pro-tip" style="background:rgba(239,68,68,0.1); border-left:3px solid #ef4444; color:#fca5a5;">
                üî• <strong>RIESGO DE HIELO EN CARBURADOR:</strong> 
                Con Temp entre 10¬∞C y 25¬∞C y alta humedad, el hielo puede formarse incluso en potencia de crucero. Use calefacci√≥n de carburador si nota ca√≠da de RPM.
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">PUNTO DE ROC√çO (SPREAD)</span>
                    <p style="font-size:0.9em;">Si la diferencia entre Temp y Roc√≠o es <strong>menor a 3¬∞C</strong>, la formaci√≥n de niebla es inminente.</p>
                </div>
                <div class="info-card">
                    <span class="info-title">PERFORMANCE HUMANA</span>
                    <p style="font-size:0.9em;">Temp > 30¬∞C en cabina reduce la capacidad cognitiva del piloto y aumenta la fatiga. Mant√©ngase hidratado.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="modRadar" class="modal-overlay" >
        <div class="modal-content" style="border: 2px solid {{ radar.color }};">
            <button class="btn-close" onclick="closeModal('modRadar')">√ó</button>
            
            <h2 style="color:{{ radar.color }}; display:flex; align-items:center; gap:10px; border-bottom:1px solid #334155; padding-bottom:15px;">
                <svg class="icon-svg" viewBox="0 0 24 24"><path d="M22 12A10 10 0 0 0 12 2v10z"/><circle cx="12" cy="12" r="10"/></svg>
                AN√ÅLISIS DE CELDAS / INESTABILIDAD
            </h2>
            
            <div style="text-align:center; margin:30px 0;">
                <h3 style="font-size:3.5em; line-height:1; margin:0; color:{{ radar.color }}; text-shadow:0 0 30px {{ radar.color }};">
                    {{ radar.estado }}
                </h3>
                <div style="color:#fff; font-size:1.4em; font-weight:bold; letter-spacing:1px; margin-top:10px;">
                    {{ radar.aviso }}
                </div>
                <p style="color:#cbd5e1; font-style:italic; margin-top:10px;">
                    "{{ radar.desc }}"
                </p>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:25px; margin-bottom:30px;">
                
                <div style="background:#020617; padding:25px; border-radius:12px; border:1px solid #1e3a8a; position:relative;">
                    <div style="font-size:0.8em; color:#94a3b8; font-weight:bold; letter-spacing:1px;">CAPE (ENERG√çA POTENCIAL)</div>
                    <div style="font-size:2.5em; color:#fff; font-weight:bold;">
                        {{ radar.cape }} <span style="font-size:0.4em; color:#64748b;">J/kg</span>
                    </div>
                    
                    <div style="width:100%; height:6px; background:#334155; margin-top:10px; border-radius:3px;">
                        <div style="width:{{ radar.cape|default:0 }}px; max-width:100%; height:100%; background:linear-gradient(90deg, #22c55e, #ef4444); border-radius:3px;"></div>
                    </div>
                    <div style="font-size:0.75em; color:#64748b; margin-top:5px;">
                        0 = Estable | 1000+ = Tormenta | 2500+ = Severo
                    </div>
                </div>

                <div style="background:#020617; padding:25px; border-radius:12px; border:1px solid #1e3a8a;">
                    <div style="font-size:0.8em; color:#94a3b8; font-weight:bold; letter-spacing:1px;">LIFTED INDEX (ESTABILIDAD)</div>
                    <div style="font-size:2.5em; color:#fff; font-weight:bold;">
                        {{ radar.li }}
                    </div>
                    <div style="font-size:0.9em; color: {% if radar.li < 0 %}#ef4444{% else %}#22c55e{% endif %}; font-weight:bold;">
                        {% if radar.li > 0 %} AIRE ESTABLE {% else %} AIRE INESTABLE {% endif %}
                    </div>
                    <div style="font-size:0.75em; color:#64748b; margin-top:15px;">
                        Positivo (+) = Estable<br>
                        Negativo (-) = Inestable (Riesgo CB)
                    </div>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">‚ö†Ô∏è PELIGROS ASOCIADOS</span>
                    <ul style="margin:0; padding-left:20px; color:#cbd5e1; font-size:0.9em;">
                        <li><strong>Microbursts:</strong> Corrientes descendentes violentas si CAPE > 2000.</li>
                        <li><strong>Granizo:</strong> Probable con LI < -4.</li>
                        <li><strong>Techo:</strong> Reducci√≥n violenta de visibilidad en chubascos (SHRA).</li>
                    </ul>
                </div>
                <div class="info-card">
                    <span class="info-title">ACCI√ìN RECOMENDADA</span>
                    <p style="margin:0; color:#fff; font-size:0.95em; font-weight:bold;">
                        {% if radar.cape > 1000 %}
                            üö´ EVITAR ZONA. Solicite desv√≠os de hasta 20NM de las celdas. No vuele debajo del yunque.
                        {% else %}
                            ‚úÖ VUELO SEGURO. Monitoree cambios en la temperatura exterior.
                        {% endif %}
                    </p>
                </div>
            </div>

        </div>
    </div>

    <div id="modVis" class="modal-overlay">
        <div class="modal-content">
            <button class="btn-close" onclick="closeModal('modVis')">√ó</button>
            <h2>VISIBILIDAD HORIZONTAL</h2>
            
            <div style="text-align:center; margin:40px 0;">
                <h3 style="font-size:5em; line-height:1; color:{{ visibilidad_panel.color }}; text-shadow:0 0 30px {{ visibilidad_panel.color }};">
                    {{ visibilidad_panel.km }} <small style="font-size:0.4em">km</small>
                </h3>
                <div style="color:#94a3b8; font-size:1.5em; text-transform:uppercase; font-weight:bold; letter-spacing:2px;">
                    {{ visibilidad_panel.estado }}
                </div>
            </div>

            <div class="info-grid">
                <div class="info-card">
                    <span class="info-title">REFERENCIA VISUAL</span>
                    <ul style="font-size:0.85em; color:#cbd5e1; padding-left:15px; margin:0;">
                        <li><strong>10 km:</strong> Horizonte claro y definido.</li>
                        <li><strong>5 km:</strong> Horizonte difuso (Neblina).</li>
                        <li><strong>1 km:</strong> Solo referencia de terreno inmediata (Niebla).</li>
                    </ul>
                </div>
                <div class="info-card">
                    <span class="info-title">ILUSIONES</span>
                    <p style="font-size:0.85em; color:#cbd5e1; margin:0;">
                        En lluvia o neblina, la pista puede parecer m√°s lejana y baja de lo que realmente est√°, induciendo aproximaciones bajas. Conf√≠e en el PAPI/VASI.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div id="modCalc" class="modal-overlay" style="z-index: 9999;">
        <div class="modal-content" style="max-width: 550px; background:#0b1120; border:1px solid #facc15; padding: 35px;" onclick="event.stopPropagation()">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; border-bottom:1px solid #1e3a8a; padding-bottom:15px;">
                <h2 style="margin:0; color:#facc15; display:flex; align-items:center; gap:12px; font-size:1.4rem; letter-spacing:1px;">
                    <svg class="icon-svg" style="width:24px; height:24px;" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="16" y1="18" x2="16" y2="18"/></svg>
                    COMPUTADORA E6B
                </h2>
                <button class="btn-close" onclick="closeModal('modCalc')" style="position:static; color:#cbd5e1; font-size:2rem; line-height:0.5;">√ó</button>
            </div>

            <div style="display:flex; gap:20px; margin-bottom:25px; align-items: flex-end;">
                
                <div style="flex: 1;">
                    <label style="color:#94a3b8; font-size:0.75em; font-weight:bold; letter-spacing:1px; display:block; margin-bottom:8px;">VALOR</label>
                    <input type="number" id="aviaInput" placeholder="0" 
                           style="width:100%; height:50px; padding:0 15px; background:#020617; border:1px solid #334155; color:#fff; border-radius:8px; font-size:1.3em; font-family:'Consolas', monospace; box-sizing:border-box;">
                </div>

                <div style="flex: 1.5;">
                    <label style="color:#94a3b8; font-size:0.75em; font-weight:bold; letter-spacing:1px; display:block; margin-bottom:8px;">TIPO DE CONVERSI√ìN</label>
                    <select id="aviaType" 
                            style="width:100%; height:50px; padding:0 15px; background:#020617; border:1px solid #334155; color:#fff; border-radius:8px; font-size:1em; cursor:pointer; box-sizing:border-box;">
                        <option disabled style="color: gold; font-weight: bold;">--- VELOCIDAD ---</option>
                        <option value="kts_kmh">Nudos (KT) ‚Üí Km/h</option>
                        <option value="kmh_kts">Km/h ‚Üí Nudos (KT)</option>
                        <option disabled style="color: gold; font-weight: bold;">--- ALTITUD ---</option>
                        <option value="ft_m">Pies (ft) ‚Üí Metros (m)</option>
                        <option value="m_ft">Metros (m) ‚Üí Pies (ft)</option>
                        <option disabled style="color: gold; font-weight: bold;">--- PRESI√ìN ---</option>
                        <option value="hpa_in">hPa ‚Üí inHg</option>
                        <option value="in_hpa">inHg ‚Üí hPa</option>
                        <option disabled style="color: gold; font-weight: bold;">--- PESO ---</option>
                        <option value="kg_lb">Kg ‚Üí Lbs</option>
                        <option value="lb_kg">Lbs ‚Üí Kg</option>
                        <option value="gal_lit">Galones (gal) ‚Üí Litros (L)</option>
                    </select>
                </div>
            </div>

            <button onclick="calcAviation()" 
                    style="width:100%; padding:15px; background: linear-gradient(45deg, #facc15, #fbbf24); color:#000; font-weight:800; border:none; border-radius:8px; cursor:pointer; font-size:1.1em; letter-spacing:1px; box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3); transition: transform 0.1s;">
                CALCULAR
            </button>

            <div style="margin-top:25px; background:#000; border:1px solid #334155; border-radius:12px; padding:20px; text-align:right; display:flex; justify-content:space-between; align-items:center;">
                <span style="color:#64748b; font-size:0.8em; font-weight:bold;">RESULTADO:</span>
                <div style="text-align:right;">
                    <span id="aviaResult" style="font-family:'Consolas', monospace; font-size:2.5em; color:#facc15; display:block; line-height:1; text-shadow:0 0 10px rgba(250,204,21,0.3);">0.00</span> 
                    <span id="aviaUnit" style="color:#94a3b8; font-size:0.9em; font-weight:bold; letter-spacing:1px;">UNIDAD</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FUNCIONES MODALES ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        window.onclick = function(event) { 
            if (event.target.classList.contains('modal-overlay')) {
            event.target.style.display = "none"; 
            }
        }

        function downloadChart() {
            const link = document.createElement('a'); link.download = 'perfil_vuelo.png';
            link.href = document.getElementById('aereoChart').toDataURL('image/png'); link.click();
        }

        // --- CALCULADORA ---
        function calcAviation() {
            const val = parseFloat(document.getElementById('aviaInput').value);
            const type = document.getElementById('aviaType').value;
            let res = 0, unit = "";
            if (isNaN(val)) return;

            if (type === 'kts_kmh') { res = val * 1.852; unit = 'km/h'; }
            else if (type === 'kmh_kts') { res = val / 1.852; unit = 'KT'; }
            else if (type === 'ft_m') { res = val / 3.281; unit = 'm'; }
            else if (type === 'm_ft') { res = val * 3.281; unit = 'ft'; }
            else if (type === 'hpa_in') { res = val * 0.02953; unit = 'inHg'; }
            else if (type === 'in_hpa') { res = val / 0.02953; unit = 'hPa'; }
            else if (type === 'kg_lb') { res = val * 2.20462; unit = 'lb'; }
            else if (type === 'lb_kg') { res = val / 2.20462; unit = 'kg'; }
            else if (type === 'gal_lit') { res = val * 3.785; unit = 'L'; }

            document.getElementById('aviaResult').innerText = res.toFixed(2);
            document.getElementById('aviaUnit').innerText = unit;
        }

        // --- GR√ÅFICO INTELIGENTE (FL300 INTEGRADO) ---
        let myChart = null;
        let windDataLevels = {};
        let cloudDataLevels = {};

        function getLabels() {
            const isEnglish = typeof Weglot !== 'undefined' && Weglot.getCurrentLang() === 'en';
            return {
                windLabel: isEnglish ? 'Wind (KT)' : 'Viento (KT)',
                coverageLabel: isEnglish ? 'Total Coverage (%)' : 'Cobertura Total (%)',
                cloudsLow: isEnglish ? 'Low Clouds (<FL065)' : 'Nubes Bajas (<FL065)',
                cloudsMid: isEnglish ? 'Mid Clouds (FL065-FL200)' : 'Nubes Medias (FL065-FL200)',
                cloudsHigh: isEnglish ? 'High Clouds (>FL200)' : 'Nubes Altas (>FL200)',
                levelSfc: isEnglish ? 'LEVEL: SURFACE (SFC) | RUNWAY REFERENCE' : 'NIVEL: SUPERFICIE (SFC) | REFERENCIA PISTA',
                levelAlt: isEnglish ? 'LEVEL: {level} FEET (MSL) | ACTIVE LAYER' : 'NIVEL: {level} PIES (MSL) | CAPA ACTIVA',
                windAxis: isEnglish ? 'Wind (KT)' : 'Viento (KT)',
                cloudsAxis: isEnglish ? 'Clouds (%)' : 'Nubes (%)'
            };
        }

        function renderAereoChart() {
            const labels = getLabels();
            const ctx = document.getElementById('aereoChart').getContext('2d');
            
            const chartLabels = {{ grafico_aereo.labels|safe }};
            
            // NUBES (Capas)
            const c_total = {{ grafico_aereo.nubes_total|safe }};
            const c_low   = {{ grafico_aereo.nubes_low|safe }};
            const c_mid   = {{ grafico_aereo.nubes_mid|safe }};
            const c_high  = {{ grafico_aereo.nubes_high|safe }};
            
            // VIENTOS
            const rawSFC   = {{ grafico_aereo.v_sfc|safe }};
            const raw2000  = {{ grafico_aereo.v_2000|safe }};
            const raw5000  = {{ grafico_aereo.v_5000|safe }};
            const raw10000 = {{ grafico_aereo.v_10000|safe }};
            const raw30000 = {{ grafico_aereo.v_30000|safe }};

            // Mapeo Nudos
            windDataLevels = {
                'SFC':   rawSFC.map(v => (v / 1.852).toFixed(1)),
                '2000':  raw2000.map(v => (v / 1.852).toFixed(1)),
                '5000':  raw5000.map(v => (v / 1.852).toFixed(1)),
                '10000': raw10000.map(v => (v / 1.852).toFixed(1)),
                '30000': raw30000.map(v => (v / 1.852).toFixed(1))
            };

            // Mapeo Nubes
            cloudDataLevels = {
                'SFC':   { data: c_total, label: labels.coverageLabel },
                '2000':  { data: c_low,   label: labels.cloudsLow },
                '5000':  { data: c_low,   label: labels.cloudsLow },
                '10000': { data: c_mid,   label: labels.cloudsMid },
                '30000': { data: c_high,  label: labels.cloudsHigh }
            };

            let gradientWind = ctx.createLinearGradient(0, 0, 0, 400);
            gradientWind.addColorStop(0, 'rgba(59, 130, 246, 0.6)'); 
            gradientWind.addColorStop(1, 'rgba(59, 130, 246, 0.0)');

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            type: 'line',
                            label: labels.windLabel,
                            data: windDataLevels['SFC'],
                            borderColor: '#60a5fa',
                            backgroundColor: gradientWind,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.3,
                            yAxisID: 'y',
                            pointRadius: 4,
                            pointBackgroundColor: '#1e3a8a'
                        },
                        {
                            type: 'bar',
                            label: labels.coverageLabel,
                            data: c_total,
                            backgroundColor: 'rgba(148, 163, 184, 0.3)',
                            borderRadius: 4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { labels: { color: '#cbd5e1' } } },
                    scales: {
                        y: { 
                            position: 'left', 
                            grid: { color: '#1e3a8a' }, 
                            ticks: { color: '#60a5fa' }, 
                            title: { display: true, text: labels.windAxis, color: '#60a5fa' } 
                        },
                        y1: { 
                            position: 'right', 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8' }, 
                            max: 100, 
                            title: { display: true, text: labels.cloudsAxis, color: '#94a3b8' } 
                        },
                        x: { grid: { color: '#1e3a8a' }, ticks: { color: '#cbd5e1' } }
                    }
                }
            });
        }

        function updateAltitude(level, btn) {
            if (!myChart) return;
            const labels = getLabels();
            
            myChart.data.datasets[0].data = windDataLevels[level];
            myChart.data.datasets[1].data = cloudDataLevels[level].data;
            myChart.data.datasets[1].label = cloudDataLevels[level].label;
            
            myChart.update();
            
            document.querySelectorAll('.btn-alt').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            const subTitle = document.getElementById('chartSubTitle');
            if(level === 'SFC') {
                subTitle.innerText = labels.levelSfc;
                subTitle.style.color = "#64748b";
            } else {
                subTitle.innerText = labels.levelAlt.replace('{level}', level);
                subTitle.style.color = "#facc15";
            }
        }

        // Inicializar gr√°fico al cargar
        document.addEventListener("DOMContentLoaded", renderAereoChart);

        // Listener para cambios de idioma Weglot
        if (typeof Weglot !== 'undefined') {
            Weglot.on('languageChanged', renderAereoChart);
        }

        // --- MANEJADOR DE MODALES (CLICK EN FONDO) ---
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.style.display = 'none';
                }
            });
        });
    </script>

<div class="chat-container">
    <div class="chat-header">
        <h3>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline; margin-right:8px;">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/>
            </svg>
            TuClima IA
        </h3>
        <span class="status-dot"></span>
    </div>
    
    <div class="chat-messages" id="chat-box">
        <div class="message bot-msg">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:inline; margin-right:6px; vertical-align:middle;">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            ¬°Hola! Soy tu asistente meteorol√≥gico. ¬øQu√© informaci√≥n necesitas consultar hoy?
        </div>
    </div>

    <div class="chat-input-container" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #1e293b; border-top: 1px solid #334155;">
    
    <input type="file" id="file-input" style="display: none;" accept="image/*,.pdf,.csv,.xlsx">
    <button type="button" onclick="document.getElementById('file-input').click()" style="background: none; border: none; cursor: pointer; padding: 8px; color: #94a3b8; transition: 0.2s;" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#94a3b8'">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/>
        </svg>
    </button>

    <div id="file-preview" style="min-width:120px; color:#e2e8f0; font-size:0.95em; font-family:'Poppins',sans-serif;"></div>

    <input type="text" id="user-input" placeholder="Escribir..." style="flex: 1; padding: 12px; border: 1px solid #334155; border-radius: 6px; background: #0f172a; color: #e2e8f0; outline: none; font-family: 'Poppins', sans-serif;">

    <button onclick="enviarMensaje()" style="background: #4ade80; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; display: flex; align-items: center; gap: 6px;" onmouseover="this.style.background='#22c55e'" onmouseout="this.style.background='#4ade80'">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
        Enviar
    </button>
</div>

<script>
    // --- CONFIGURACI√ìN AGRO INTELLIGENCE PRO ---

const urlN8N = "http://localhost:5678/webhook/chat"; // URL de Desarrollo local
let sessionId = localStorage.getItem("chatSessionId") || generateUUID();
localStorage.setItem("chatSessionId", sessionId);

// Historial para flechas del teclado
let historialMensajes = [];
let indiceHistorial = -1;

function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
    });
}

// 1. GESTI√ìN DE FLECHAS (Arriba/Abajo)
document.getElementById("user-input").addEventListener("keydown", (e) => {
    const input = e.target;
    if (e.key === "ArrowUp") {
        if (historialMensajes.length > 0 && indiceHistorial < historialMensajes.length - 1) {
            indiceHistorial++;
            input.value = historialMensajes[historialMensajes.length - 1 - indiceHistorial];
        }
        e.preventDefault();
    } else if (e.key === "ArrowDown") {
        if (indiceHistorial > 0) {
            indiceHistorial--;
            input.value = historialMensajes[historialMensajes.length - 1 - indiceHistorial];
        } else {
            indiceHistorial = -1;
            input.value = "";
        }
        e.preventDefault();
    } else if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (input.value.trim() !== "") {
            enviarMensaje();
        }
    }
});

// Mostrar archivo seleccionado en la casilla de mensaje
document.getElementById("file-input").addEventListener("change", function() {
    const file = this.files[0];
    const preview = document.getElementById("file-preview");
    if (file) {
        let icon = '';
        if (file.type.startsWith('image/')) {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>';
        } else if (file.type === 'application/pdf') {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>';
        } else if (file.type.includes('excel') || file.name.match(/\.(xlsx|xls|csv)$/i)) {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><rect x="7" y="7" width="2" height="2"/><rect x="13" y="7" width="2" height="2"/><rect x="7" y="13" width="2" height="2"/><rect x="13" y="13" width="2" height="2"/></svg>';
        } else {
            icon = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
        }
        preview.innerHTML = '<span style="display:flex; align-items:center; gap:6px;">' + icon + '<span>' + file.name + '</span></span>';
    } else {
        preview.innerHTML = '';
    }
});

// 2. ENV√çO DE MENSAJES Y ARCHIVOS
async function enviarMensaje() {

    const input = document.getElementById("user-input");
    const fileInput = document.getElementById("file-input");
    const filePreview = document.getElementById("file-preview");
    const chatBox = document.getElementById("chat-box");
    const texto = input.value.trim();
    const archivo = fileInput.files[0];

    if (!texto && !archivo) return;

    // Guardar en historial
    if (texto) {
        historialMensajes.push(texto);
        indiceHistorial = -1;
    }

    // Mostrar en UI
    let icon = '';
    if (archivo) {
        if (archivo.type.startsWith('image/')) {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>';
        } else if (archivo.type === 'application/pdf') {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><text x="8" y="16" font-size="8" font-weight="bold" fill="currentColor">PDF</text></svg>';
        } else if (archivo.type.includes('excel') || archivo.name.match(/\.(xlsx|xls|csv)$/i)) {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><rect x="7" y="7" width="2" height="2"/><rect x="13" y="7" width="2" height="2"/><rect x="7" y="13" width="2" height="2"/><rect x="13" y="13" width="2" height="2"/></svg>';
        } else {
            icon = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>';
        }
    }
    chatBox.innerHTML += `<div class=\"message user-msg\"><b>T√∫:</b> ${texto} ${archivo ? `<br>${icon} <i>Archivo: ${archivo.name}</i>` : ''}</div>`;
    input.value = "";
    filePreview.innerHTML = '';
    chatBox.scrollTop = chatBox.scrollHeight;

    // Animaci√≥n de espera de IA
    const typingId = 'ia-typing';
    if (!document.getElementById(typingId)) {
        chatBox.innerHTML += `<div class=\"chat-typing\" id=\"${typingId}\"><b>IA:</b> <span class=\"dot-typing\"><span></span><span></span><span></span></span></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    try {
        const formData = new FormData();
        formData.append("chatInput", texto);
        formData.append("sessionId", sessionId);
        if (archivo) {
            formData.append("data00", archivo); 
        }

        const respuesta = await fetch(urlN8N, {
            method: "POST",
            body: formData 
        });

        const datos = await respuesta.json();
        
        // --- AQU√ç EST√Å EL CAMBIO CLAVE ---
        let respuestaIA = datos.output || "Procesado correctamente.";
        
        // Buscamos si hay un formato [Texto](Enlace) y lo convertimos a un link con clase de bot√≥n profesional
        const respuestaIAConLinks = respuestaIA.replace(
            /\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g,
            '<a href="$2" target="_blank" class="download-link">$1</a>'
        );

        // Eliminar animaci√≥n de espera
        const typingDiv = document.getElementById(typingId);
        if (typingDiv) typingDiv.remove();

        chatBox.innerHTML += `<div class=\"message bot-msg\"><b>IA:</b> ${respuestaIAConLinks}</div>`;
        // --------------------------------
        
        fileInput.value = ""; 
    } catch (error) {
        // Eliminar animaci√≥n de espera
        const typingDiv = document.getElementById(typingId);
        if (typingDiv) typingDiv.remove();
        chatBox.innerHTML += `<div class=\"message bot-msg\" style=\"color:red;\">‚ö†Ô∏è Error de conexi√≥n.</div>`;
    }
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>


</body>
</html>